<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€¼ç­è¡¨ 2025-2026 (é›²ç«¯åŒæ­¥ç‰ˆ v4.3)</title>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- å¼•å…¥ Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- å¼•å…¥ SheetJS (Excel è™•ç†) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.Firebase = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken,
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot,
            collection
        };
    </script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
            -webkit-font-smoothing: antialiased;
            background-color: #FEF9E7;
            user-select: none;
            -webkit-user-select: none;
        }
        .paper-texture {
            background-color: #FEF9E7;
            background-image: radial-gradient(#E5E0C8 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .btn-press:active { transform: translateY(1px); }
        th, td { vertical-align: middle; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .toast-enter { animation: slideUp 0.3s ease-out forwards; }
        .cursor-wait { cursor: wait; opacity: 0.7; }
        .shift-icon-lg { font-size: 1.5rem; line-height: 1; }
    </style>
</head>
<body class="paper-texture h-screen overflow-hidden text-slate-700">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, getDoc, setDoc, onSnapshot, collection } = window.Firebase;

        // --- SVG Icons ---
        const IconBase = ({ children, size = 20, className = "", ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const ChevronLeft = (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const XIcon = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const CalendarIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const Eraser = (props) => <IconBase {...props}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></IconBase>;
        const Hand = (props) => <IconBase {...props}><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a9 9 0 0 1 3.24-14.22"/></IconBase>;
        const SaveIcon = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const LogOutIcon = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
        const UserIcon = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const InfoIcon = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></IconBase>;
        const CheckIcon = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const UploadIcon = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const DownloadIcon = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const ScrollTextIcon = (props) => <IconBase {...props}><path d="M15 12h-5"/><path d="M15 8h-5"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/><path d="M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v1a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v2a1 1 0 0 0 1 1h3"/></IconBase>;
        const LockIcon = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const UnlockIcon = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>;
        const ChartBarIcon = (props) => <IconBase {...props}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></IconBase>;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAQcIBp-giqjuOxE5D7EjelLnIpimFYDpk",
            authDomain: "otfape1.firebaseapp.com",
            projectId: "otfape1",
            storageBucket: "otfape1.firebasestorage.app",
            messagingSenderId: "19216643898",
            appId: "1:19216643898:web:cebc48af06015bcad78203"
        };
        
        const appId = 'shift-schedule-app'; 

        let db = null;
        let auth = null;
        let isConfigured = false;
        
        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isConfigured = true;
            } catch (err) {
                console.error("Firebase init failed:", err);
            }
        }

        // --- CONSTANTS ---
        const USER_LIST = [
            { id: 'v02455', name: 'å‘¨å“²ç¶­', type: 'NORMAL' },
            { id: 'v02457', name: 'é™³æ³“å»·', type: 'NORMAL' },
            { id: 'v03111', name: 'ç‹æ³“å‡±', type: 'ROTATION' }, // Bçµ„ No.1
            { id: 'v03369', name: 'é™³å˜‰è»’', type: 'ROTATION' }, // Açµ„ No.1
            { id: 'v04151', name: 'å¼µçš“ç¿”', type: 'ROTATION' }, // Bçµ„ No.2
            { id: 'v03370', name: 'é™³æµ©éœ–', type: 'ROTATION' }, // Açµ„ No.2
            { id: 'v04457', name: 'ç¿å­æ¶µ', type: 'ROTATION' }, // Bçµ„ No.3
            { id: 'v03735', name: 'è¶™å©‰å‰', type: 'ROTATION' }, // Açµ„ No.3
            { id: 'v03282', name: 'æ¸¸ä½³æ†²', type: 'ROTATION' }, // Bçµ„ No.4
            { id: 'v04463', name: 'æ—æ˜å„’', type: 'ROTATION' }  // Açµ„ No.4
        ];

        // ç­åˆ¥è¨­å®š - æ›´æ–°ç‚º æ—¥A/B å¤œA/B Cç­
        const SHIFT_TYPES = {
            NORMAL: { id: 'NORMAL', name: 'å¸¸æ—¥', time: '08:30-17:30', color: 'bg-white border border-slate-200 shadow-sm text-slate-800', icon: 'â˜€ï¸' },
            
            // æ—¥ç­ A/B
            DAY_A: { id: 'DAY_A', name: 'æ—¥A', time: '07:20-19:20', color: 'bg-green-100 text-green-900 border-green-200 shadow-sm', icon: 'â˜€ï¸A' },
            DAY_B: { id: 'DAY_B', name: 'æ—¥B', time: '07:20-19:20', color: 'bg-yellow-100 text-yellow-900 border-yellow-200 shadow-sm', icon: 'â˜€ï¸B' },
            
            // å¤œç­ A/B
            NIGHT_A: { id: 'NIGHT_A', name: 'å¤œA', time: '19:20-07:20', color: 'bg-purple-100 text-purple-900 border-purple-200 shadow-sm', icon: 'ğŸŒ™A' },
            NIGHT_B: { id: 'NIGHT_B', name: 'å¤œB', time: '19:20-07:20', color: 'bg-indigo-100 text-indigo-900 border-indigo-200 shadow-sm', icon: 'ğŸŒ™B' },
            
            // å¹³æ—¥/å‡æ—¥å¤œ
            EVE_WEEKDAY: { id: 'EVE_WEEKDAY', name: 'å¹³æ—¥å¤œ', time: '15:00-24:00', color: 'bg-purple-200 text-purple-900 border-purple-300 shadow-sm', icon: 'ğŸŒ' },
            EVE_WEEKEND: { id: 'EVE_WEEKEND', name: 'å‡æ—¥å¤œ', time: '15:00-24:00', color: 'bg-gray-200 text-gray-800 border-gray-300 shadow-sm', icon: 'ğŸŒš' },

            // æ–°å¢: å°å¤œ
            LITTLE_NIGHT: { id: 'LITTLE_NIGHT', name: 'å°å¤œ', time: '16:00-24:00', color: 'bg-pink-100 text-pink-900 border-pink-200 shadow-sm', icon: 'ğŸŒ›' },

            // Cç­
            ROTATION_C: { id: 'ROTATION_C', name: 'Cç­', time: 'è·Ÿå€¼', color: 'bg-cyan-100 text-cyan-900 border-cyan-200 shadow-sm', icon: 'ğŸ‘¥' },
            
            LEAVE: { id: 'LEAVE', name: 'è«‹å‡', time: 'OFF', color: 'bg-white border border-slate-200 shadow-sm text-slate-800', icon: 'ğŸ›Œ' },
            REST: { id: 'REST', name: 'ä¼‘', time: 'REST', color: 'border-2 border-dashed border-slate-300 text-slate-400', icon: 'ğŸ’¤' }
        };

        const TOOL_ERASER = {
            id: 'ERASER', name: 'æ¸…é™¤', time: '',
            color: 'bg-white text-slate-500 border-2 border-dashed border-slate-300', 
            icon: <Eraser size={18} />
        };

        const HOLIDAYS = {
            '2025-01-25': 'æ˜¥ç¯€', '2025-01-26': 'æ˜¥ç¯€', '2025-01-27': 'é™¤å¤•', '2025-01-28': 'æ˜¥ç¯€', '2025-01-29': 'æ˜¥ç¯€', 
            '2025-01-30': 'æ˜¥ç¯€', '2025-01-31': 'æ˜¥ç¯€', '2025-02-01': 'æ˜¥ç¯€', '2025-02-02': 'æ˜¥ç¯€',
            '2025-02-28': '228', '2025-03-01': '228', '2025-03-02': '228',
            '2025-04-03': 'å…’ç«¥', '2025-04-04': 'æ¸…æ˜', '2025-04-05': 'æ¸…æ˜', '2025-04-06': 'æ¸…æ˜',
            '2025-05-30': 'ç«¯åˆ', '2025-05-31': 'ç«¯åˆ', '2025-06-01': 'ç«¯åˆ',
            '2025-09-27': 'æ•™å¸«', '2025-09-28': 'æ•™å¸«', '2025-09-29': 'æ•™å¸«',
            '2025-10-04': 'ä¸­ç§‹', '2025-10-05': 'ä¸­ç§‹', '2025-10-06': 'ä¸­ç§‹',
            '2025-10-10': 'åœ‹æ…¶', '2025-10-11': 'åœ‹æ…¶', '2025-10-12': 'åœ‹æ…¶',
            '2025-10-24': 'å…‰å¾©', '2025-10-25': 'å…‰å¾©', '2025-10-26': 'å…‰å¾©',
            '2026-02-14': 'æ˜¥ç¯€', '2026-02-15': 'æ˜¥ç¯€', '2026-02-16': 'é™¤å¤•', '2026-02-17': 'æ˜¥ç¯€', '2026-02-18': 'æ˜¥ç¯€',
            '2026-02-19': 'æ˜¥ç¯€', '2026-02-20': 'æ˜¥ç¯€', '2026-02-21': 'æ˜¥ç¯€', '2026-02-22': 'æ˜¥ç¯€',
            '2026-02-27': '228', '2026-02-28': '228', '2026-03-01': '228',
            '2026-04-03': 'å…’ç«¥', '2026-04-04': 'æ¸…æ˜', '2026-04-05': 'æ¸…æ˜', '2026-04-06': 'æ¸…æ˜',
            '2026-05-01': 'å‹å‹•', '2026-05-02': 'å‹å‹•', '2026-05-03': 'å‹å‹•',
            '2026-06-19': 'ç«¯åˆ', '2026-06-20': 'ç«¯åˆ', '2026-06-21': 'ç«¯åˆ',
            '2026-09-25': 'ä¸­ç§‹', '2026-09-26': 'ä¸­ç§‹', '2026-09-27': 'æ•™å¸«', '2026-09-28': 'æ•™å¸«',
            '2026-10-09': 'åœ‹æ…¶', '2026-10-10': 'åœ‹æ…¶', '2026-10-11': 'åœ‹æ…¶',
            '2026-10-24': 'å…‰å¾©', '2026-10-25': 'å…‰å¾©', '2026-10-26': 'å…‰å¾©',
            '2026-12-25': 'è¡Œæ†²', '2026-12-26': 'è¡Œæ†²', '2026-12-27': 'è¡Œæ†²',
        };

        const getDateStr = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const isWeekend = (date) => {
            const day = date.getDay();
            return day === 0 || day === 6;
        };

        const getShiftLabel = (shift) => {
            if (!shift) return '';
            if (shift.id === 'LEAVE') return shift.icon;
            if (shift.id === 'REST') return shift.icon;
            if (shift.id === 'NORMAL') return shift.icon;
            if (shift.icon.length <= 2) return shift.icon; // For simple emojis
            return shift.name; // For complex names like æ—¥A
        };

        const getShiftName = (shiftId) => {
             if (!shiftId) return "";
             return SHIFT_TYPES[shiftId]?.name || shiftId;
        };

        const getShiftIdByName = (name) => {
            for (const key in SHIFT_TYPES) {
                if (SHIFT_TYPES[key].name === name) return key;
            }
            return null;
        };

        const getPayday = (year, month) => {
            let d = new Date(year, month, 25);
            while (true) {
                const dateStr = getDateStr(d);
                const dayOfWeek = d.getDay();
                const isWknd = dayOfWeek === 0 || dayOfWeek === 6;
                const isHol = !!HOLIDAYS[dateStr];
                if (!isWknd && !isHol) {
                    return d;
                }
                d.setDate(d.getDate() - 1);
            }
        };

        // --- TOAST COMPONENT ---
        function Toast({ message, type = 'info', onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColors = {
                info: 'bg-slate-800 text-white',
                success: 'bg-green-600 text-white',
                error: 'bg-red-600 text-white',
                warning: 'bg-yellow-500 text-white'
            };

            return (
                <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-xl z-[100] text-sm font-bold flex items-center gap-2 toast-enter ${bgColors[type]}`}>
                    {type === 'error' && <AlertTriangle size={16} />}
                    {type === 'success' && <CheckIcon size={16} />}
                    {message}
                </div>
            );
        }

        // --- LOGIN COMPONENT ---
        function LoginScreen({ onLogin }) {
            const [inputId, setInputId] = useState('');
            const [error, setError] = useState('');
            const [eggClicks, setEggClicks] = useState(0);
            const eggTimerRef = useRef(null);

            const handleEggClick = () => {
                setEggClicks(prev => {
                    const newCount = prev + 1;
                    if (newCount >= 5) {
                        if (eggTimerRef.current) clearTimeout(eggTimerRef.current);
                        onLogin({ id: 'vip', name: 'v02457', type: 'NORMAL' });
                        return 0;
                    }
                    return newCount;
                });

                if (eggTimerRef.current) clearTimeout(eggTimerRef.current);
                eggTimerRef.current = setTimeout(() => {
                    setEggClicks(0);
                }, 500);
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const user = USER_LIST.find(u => u.id.toLowerCase() === inputId.toLowerCase());
                if (user) {
                    onLogin(user);
                } else {
                    setError('å·¥è™ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ (ä¾‹å¦‚ v03111)');
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 paper-texture">
                    <div className="bg-white p-8 rounded-2xl shadow-xl border-4 border-slate-800 w-full max-w-sm animate-fade-in text-center">
                        <div className="w-20 h-20 bg-yellow-300 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-slate-800 shadow-[4px_4px_0px_rgba(0,0,0,1)] cursor-pointer active:scale-95 transition-transform" onClick={handleEggClick}>
                            <UserIcon size={40} className="text-slate-800" />
                        </div>
                        <h2 className="text-2xl font-black text-slate-800 mb-2">ç­è¡¨æ‰‹å¸³ç™»å…¥</h2>
                        <p className="text-slate-500 mb-6 text-sm">è«‹è¼¸å…¥æ‚¨çš„ 6 ç¢¼å·¥è™Ÿä»¥é–‹å§‹ä½¿ç”¨</p>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="text" placeholder="å·¥è™Ÿ (ä¾‹å¦‚: v03111)" value={inputId} onChange={(e) => { setInputId(e.target.value); setError(''); }} className="w-full text-center text-xl font-bold p-3 rounded-xl border-2 border-slate-300 focus:border-slate-800 focus:ring-0 outline-none transition-colors" maxLength={6} />
                            {error && <p className="text-red-500 text-sm font-bold animate-pulse">{error}</p>}
                            <button type="submit" className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold text-lg hover:bg-slate-700 transition-transform active:scale-95 shadow-[4px_4px_0px_rgba(0,0,0,0.2)]">é€²å…¥ç³»çµ±</button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- APP COMPONENT ---
        function ShiftScheduleMatrix() {
            const [currentUser, setCurrentUser] = useState(null); 
            const [viewStartDate, setViewStartDate] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() - 7); 
                return d;
            });

            const [schedule, setSchedule] = useState({});
            const [rotationCycles, setRotationCycles] = useState({}); 
            const [weekNightCycles, setWeekNightCycles] = useState({}); 
            const [lastModifiedInfo, setLastModifiedInfo] = useState(null); 
            const [changeLogs, setChangeLogs] = useState([]); 
            const [selectedTool, setSelectedTool] = useState(null); 
            const scrollRef = useRef(null);
            
            // Drag states
            const [isDragging, setIsDragging] = useState(false);
            const dragStartRef = useRef(false);
            const tempScheduleRef = useRef({}); 
            
            const [activeCell, setActiveCell] = useState(null);
            const [userStatsModal, setUserStatsModal] = useState(null); 
            const [showAutoFill, setShowAutoFill] = useState(false); // Fixed missing state
            const [confirmModal, setConfirmModal] = useState({ show: false, title: '', msg: '', action: null, isDangerous: false });
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [showLogModal, setShowLogModal] = useState(false); 
            const [toast, setToast] = useState(null);
            const fileInputRef = useRef(null);
            
            const [isLocked, setIsLocked] = useState(true);

            // Settings for AutoFill
            const [targetUser, setTargetUser] = useState(USER_LIST[0].name);
            const [autoStartDate, setAutoStartDate] = useState(getDateStr(new Date()));
            const [autoRule, setAutoRule] = useState('4-2');
            const [autoShiftType, setAutoShiftType] = useState('ROTATION_A');
            const [autoRounds, setAutoRounds] = useState(8); 
            const [autoWeeksDuration, setAutoWeeksDuration] = useState(1);

            const [firebaseUser, setFirebaseUser] = useState(null);
            const [isSaving, setIsSaving] = useState(false); 
            const [isConnected, setIsConnected] = useState(false);
            const [permissionError, setPermissionError] = useState(false);

            const showToast = (message, type = 'info') => { setToast({ message, type }); };

            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (error) { console.error("Auth failed:", error); } };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (user) => { setFirebaseUser(user); setIsConnected(!!user); });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isConfigured || !firebaseUser || !db) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shift_schedule_team', 'shared_matrix');
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    setPermissionError(false); 
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setSchedule(data.schedule || {});
                        setRotationCycles(data.rotationCycles || {});
                        setWeekNightCycles(data.weekNightCycles || {});
                        setChangeLogs(data.changeLogs || []); 
                        if (data.lastModifiedBy && data.lastModifiedAt) {
                            setLastModifiedInfo({ by: data.lastModifiedBy, at: data.lastModifiedAt });
                        }
                    } else {
                        setDoc(docRef, { schedule: {}, rotationCycles: {}, weekNightCycles: {}, changeLogs: [] }, { merge: true });
                    }
                }, (error) => {
                    console.error("Sync error:", error);
                    setIsConnected(false);
                    if (error.code === 'permission-denied') { setPermissionError(true); } else { showToast("è³‡æ–™åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯", "error"); }
                });
                return () => unsubscribe();
            }, [firebaseUser]);

            useEffect(() => {
                const handleGlobalMouseUp = () => {
                    if (dragStartRef.current) {
                        dragStartRef.current = false;
                        setIsDragging(false);
                        if (Object.keys(tempScheduleRef.current).length > 0) {
                            const finalSchedule = { ...schedule };
                            Object.keys(tempScheduleRef.current).forEach(u => {
                                finalSchedule[u] = { ...finalSchedule[u], ...tempScheduleRef.current[u] };
                            });
                            const logEntry = {
                                time: new Date().toLocaleString('zh-TW'),
                                user: currentUser ? currentUser.name : 'Unknown',
                                action: 'æ‰¹é‡ä¿®æ”¹ (æ»‘é¼ æ‹–æ›³)',
                                detail: `æ›´æ–°äº† ${Object.keys(tempScheduleRef.current).length} ä½äººå“¡çš„ç­è¡¨`
                            };
                            saveToDb({ schedule: finalSchedule }, false, logEntry);
                            tempScheduleRef.current = {}; 
                        }
                    }
                };
                window.addEventListener('mouseup', handleGlobalMouseUp);
                return () => window.removeEventListener('mouseup', handleGlobalMouseUp);
            }, [schedule, currentUser]); 

            const saveToDb = (newData = {}, isOverwrite = false, logEntry = null) => {
                return new Promise(async (resolve) => {
                    const newSchedule = newData.schedule !== undefined ? newData.schedule : schedule;
                    const newRotationCycles = newData.rotationCycles !== undefined ? newData.rotationCycles : rotationCycles;
                    const newWeekNightCycles = newData.weekNightCycles !== undefined ? newData.weekNightCycles : weekNightCycles;
                    
                    let newLogs = [...changeLogs];
                    if (logEntry) {
                        newLogs.unshift(logEntry);
                        if (newLogs.length > 20) newLogs = newLogs.slice(0, 20); 
                    }

                    if (!isConfigured) {
                        setSchedule(newSchedule); setRotationCycles(newRotationCycles); setWeekNightCycles(newWeekNightCycles); setChangeLogs(newLogs);
                        if (!isOverwrite) showToast("å°šæœªè¨­å®šè³‡æ–™åº«ï¼Œåƒ…æš«å­˜æ–¼æœ¬æ©Ÿ", "warning");
                        resolve(true); return;
                    }
                    if (!auth || !firebaseUser) {
                        if (!isOverwrite) showToast("å°šæœªé€£ç·šï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¨­å®š", "error");
                        signInAnonymously(auth).catch(e => console.error(e));
                        resolve(false); return;
                    }
                    if (!db) {
                         if (!isOverwrite) showToast("è³‡æ–™åº«æœªåˆå§‹åŒ–", "error");
                         resolve(false); return;
                    }

                    setIsSaving(true);
                    setPermissionError(false); 
                    const timeoutPromise = new Promise(r => setTimeout(() => r('TIMEOUT'), 15000)); 
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shift_schedule_team', 'shared_matrix');
                    const now = new Date();
                    const timeString = `${now.getMonth() + 1}/${now.getDate()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    
                    const dataToSave = { 
                        schedule: newSchedule,
                        rotationCycles: newRotationCycles,
                        weekNightCycles: newWeekNightCycles,
                        changeLogs: newLogs,
                        lastModifiedBy: currentUser ? currentUser.name : 'Unknown',
                        lastModifiedAt: timeString
                    };

                    try {
                        const options = isOverwrite ? {} : { merge: true };
                        const result = await Promise.race([ setDoc(docRef, dataToSave, options), timeoutPromise ]);
                        if (result === 'TIMEOUT') throw new Error("Save timeout");
                        
                        setSchedule(newSchedule); setRotationCycles(newRotationCycles); setWeekNightCycles(newWeekNightCycles); setChangeLogs(newLogs);
                        if (!isOverwrite) showToast("å„²å­˜æˆåŠŸï¼", "success");
                        resolve(true);
                    } catch (e) {
                        console.error("Save error:", e);
                        if (e.code === 'permission-denied') { setPermissionError(true); if (!isOverwrite) showToast("å„²å­˜å¤±æ•—ï¼šæ¬Šé™ä¸è¶³", "error"); }
                        else if (e.message === "Save timeout") { if (!isOverwrite) showToast("é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ³", "warning"); }
                        else { if (!isOverwrite) showToast(`å„²å­˜å¤±æ•—: ${e.message}`, "error"); }
                        resolve(false);
                    } finally { setIsSaving(false); }
                });
            };

            const prevPeriod = () => setViewStartDate(prev => { const d = new Date(prev); d.setDate(d.getDate() - 14); return d; });
            const nextPeriod = () => setViewStartDate(prev => { const d = new Date(prev); d.setDate(d.getDate() + 14); return d; });
            const goToToday = () => { const d = new Date(); d.setDate(d.getDate() - 7); setViewStartDate(d); };

            const handleLogout = async () => {
                await saveToDb({ schedule, rotationCycles, weekNightCycles }, false);
                setCurrentUser(null); setSelectedTool(null);
            };

            const handleCellMouseDown = (e, userName, dateStr) => {
                if (isLocked) {
                    showToast("ğŸ”’ è«‹å…ˆè§£é™¤é–å®šæ‰èƒ½ç·¨è¼¯å–”ï¼", "warning");
                    return; 
                }
                if (!selectedTool) {
                    const currentShift = schedule[userName]?.[dateStr];
                    setActiveCell({ user: userName, dateStr, currentShift });
                    return;
                }
                dragStartRef.current = true;
                setIsDragging(true);
                tempScheduleRef.current = {}; 
                applyToolToCell(userName, dateStr); 
            };

            const handleCellMouseEnter = (e, userName, dateStr) => {
                if (isLocked) return; 
                if (dragStartRef.current && selectedTool) {
                    applyToolToCell(userName, dateStr);
                }
            };

            const applyToolToCell = (userName, dateStr) => {
                const newSchedule = { ...schedule }; 
                Object.keys(tempScheduleRef.current).forEach(u => {
                    newSchedule[u] = { ...newSchedule[u], ...tempScheduleRef.current[u] };
                });

                const userSchedule = { ...(newSchedule[userName] || {}) };
                if (selectedTool === 'ERASER') {
                    delete userSchedule[dateStr];
                } else {
                    userSchedule[dateStr] = selectedTool;
                }
                
                if (!tempScheduleRef.current[userName]) tempScheduleRef.current[userName] = {};
                 tempScheduleRef.current[userName] = userSchedule;

                newSchedule[userName] = userSchedule;
                setSchedule(newSchedule); 
            };

            const toggleTool = (toolId) => { if (selectedTool === toolId) setSelectedTool(null); else setSelectedTool(toolId); };

            const applyShiftFromModal = (shiftId) => {
                if (!activeCell) return;
                const { user, dateStr } = activeCell;
                const newSchedule = { ...schedule };
                const userSchedule = { ...(newSchedule[user] || {}) };
                
                let actionStr = '';
                if (shiftId === 'ERASER') {
                    delete userSchedule[dateStr];
                    actionStr = 'æ¸…é™¤';
                } else {
                    userSchedule[dateStr] = shiftId;
                    actionStr = `æ’ç­: ${SHIFT_TYPES[shiftId].name}`;
                }
                newSchedule[user] = userSchedule;
                
                const logEntry = {
                    time: new Date().toLocaleString('zh-TW'),
                    user: currentUser.name,
                    action: actionStr,
                    detail: `${user} / ${dateStr}`
                };

                saveToDb({ schedule: newSchedule }, false, logEntry);
                setActiveCell(null);
            };

            const openAutoFillFromCell = () => {
                if (!activeCell) return;
                setTargetUser(activeCell.user); setAutoStartDate(activeCell.dateStr);
                setActiveCell(null); setShowAutoFill(true);
            };

            const confirmClearUser = (userName) => {
                setConfirmModal({
                    show: true, title: `æ¸…é™¤ ${userName} çš„ç´€éŒ„`, msg: `ç¢ºå®šè¦æ¸…é™¤è©²äººå“¡çš„æ‰€æœ‰æ’ç­ç´€éŒ„å—ï¼Ÿ\n(æ³¨æ„ï¼šä¸æœƒæ¸…é™¤ 4-2 è¼ªç­èˆ‡å¹³æ—¥å°å¤œçš„é€±æœŸèƒŒæ™¯)`, isDangerous: true,
                    action: () => {
                        const newSchedule = { ...schedule };
                        delete newSchedule[userName];
                        saveToDb({ schedule: newSchedule }, false, {
                            time: new Date().toLocaleString('zh-TW'),
                            user: currentUser.name,
                            action: 'æ¸…é™¤äººå“¡ç´€éŒ„',
                            detail: `æ¸…é™¤äº† ${userName} çš„æ‰€æœ‰æ’ç­`
                        });
                        setConfirmModal({ show: false });
                        setUserStatsModal(null); 
                    }
                });
            };

            const runAutoFill = () => {
                const start = new Date(autoStartDate);
                if (isNaN(start.getTime())) return;
                let end = new Date(start);
                let endDateStr = '';

                if (autoRule === '4-2') {
                    const totalDays = autoRounds * 4;
                    const endDateObj = new Date(start);
                    endDateObj.setDate(start.getDate() + totalDays - 1); 
                    endDateStr = getDateStr(endDateObj);
                } else if (autoRule === 'week-night') {
                    const endDateObj = new Date(start);
                    endDateObj.setDate(start.getDate() + (autoWeeksDuration * 7) - 1);
                    endDateStr = getDateStr(endDateObj);
                    end = endDateObj; 
                } 

                const newSchedule = { ...schedule };
                const userSch = { ...(newSchedule[targetUser] || {}) };
                let current = new Date(start);

                if (autoRule === '4-2') {
                    const newCycles = { ...rotationCycles };
                    const userCycles = newCycles[targetUser] || [];
                    userCycles.push({ start: autoStartDate, end: endDateStr });
                    newCycles[targetUser] = userCycles;
                    const totalDays = autoRounds * 4;
                    for (let i = 0; i < totalDays; i++) {
                        let d = new Date(start);
                        d.setDate(start.getDate() + i);
                        const dStr = getDateStr(d);
                        if (i % 4 < 2) {
                            userSch[dStr] = autoShiftType;
                        } else {
                            userSch[dStr] = 'REST'; 
                        }
                    }
                    newSchedule[targetUser] = userSch;
                    saveToDb({ schedule: newSchedule, rotationCycles: newCycles }, false, {
                        time: new Date().toLocaleString('zh-TW'),
                        user: currentUser.name,
                        action: 'è‡ªå‹•æ’ç­ (4-2)',
                        detail: `${targetUser} å¾ ${autoStartDate}`
                    });
                } else if (autoRule === 'week-night') {
                    const newWNCycles = { ...weekNightCycles };
                    const userWNCycles = newWNCycles[targetUser] || [];
                    userWNCycles.push({ start: autoStartDate, end: endDateStr });
                    newWNCycles[targetUser] = userWNCycles;
                    const endLoop = new Date(start);
                    endLoop.setDate(start.getDate() + (autoWeeksDuration * 7));
                    while (current < endLoop) {
                        const day = current.getDay();
                        if (day !== 6) userSch[getDateStr(current)] = 'EVE_WEEKDAY';
                        current.setDate(current.getDate() + 1);
                    }
                    newSchedule[targetUser] = userSch;
                    saveToDb({ schedule: newSchedule, weekNightCycles: newWNCycles }, false, {
                        time: new Date().toLocaleString('zh-TW'),
                        user: currentUser.name,
                        action: 'è‡ªå‹•æ’ç­ (å°å¤œ)',
                        detail: `${targetUser} å¾ ${autoStartDate}`
                    });
                }
                setShowAutoFill(false);
            };

            const daysData = useMemo(() => {
                const arr = [];
                for (let i = 0; i < 30; i++) {
                    const date = new Date(viewStartDate);
                    date.setDate(viewStartDate.getDate() + i);
                    const dateStr = getDateStr(date);
                    arr.push({
                        date, dateStr, dayNum: date.getDate(),
                        dayOfWeek: ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][date.getDay()],
                        isWeekend: isWeekend(date),
                        holiday: HOLIDAYS[dateStr],
                        monthLabel: `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ`
                    });
                }
                return arr;
            }, [viewStartDate]);

            const monthGroups = useMemo(() => {
                const groups = [];
                if (daysData.length === 0) return groups;
                let currentMonth = daysData[0].monthLabel;
                let count = 0;
                daysData.forEach(day => {
                    if (day.monthLabel === currentMonth) { count++; } 
                    else { groups.push({ label: currentMonth, count }); currentMonth = day.monthLabel; count = 1; }
                });
                groups.push({ label: currentMonth, count });
                return groups;
            }, [daysData]);

            const calculateYearlyStats = (userName) => {
                const year = viewStartDate.getFullYear(); 
                const stats = {};
                const user = USER_LIST.find(u => u.name === userName);
                if (!user) return { stats, year };

                const d = new Date(year, 0, 1);
                const end = new Date(year, 11, 31);
                
                while (d <= end) {
                    const dateStr = getDateStr(d);
                    const s = schedule[userName]?.[dateStr];
                    
                    if (s) {
                        stats[s] = (stats[s] || 0) + 1;
                    } else {
                        const day = d.getDay();
                        const isWknd = day === 0 || day === 6;
                        const isHol = !!HOLIDAYS[dateStr];
                        
                        if (user.type === 'NORMAL' && !isWknd && !isHol) {
                            stats['NORMAL'] = (stats['NORMAL'] || 0) + 1;
                        }
                    }
                    d.setDate(d.getDate() + 1);
                }
                return { stats, year };
            };

            const handleUserClick = (userName) => {
                const { stats, year } = calculateYearlyStats(userName); 
                setUserStatsModal({ name: userName, stats, year });
            };

            const handleExport = () => {
                if (!schedule) return;
                const exportData = [];
                const header = ['å§“å', ...daysData.map(d => d.dateStr)];
                exportData.push(header);
                USER_LIST.forEach(user => {
                    const row = [user.name];
                    daysData.forEach(day => {
                        const shiftId = schedule[user.name]?.[day.dateStr];
                        if (shiftId) row.push(getShiftName(shiftId));
                        else row.push(''); 
                    });
                    exportData.push(row);
                });
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                XLSX.utils.book_append_sheet(wb, ws, "æ’ç­è¡¨");
                XLSX.writeFile(wb, `æ’ç­è¡¨_${getDateStr(new Date())}.xlsx`);
            };

            const handleImportClick = () => { fileInputRef.current.click(); };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsName = wb.SheetNames[0];
                        const ws = wb.Sheets[wsName];
                        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        if (data.length < 2) { showToast("Excel æ ¼å¼éŒ¯èª¤æˆ–ç„¡è³‡æ–™", "error"); return; }
                        const headerRow = data[0];
                        const newSchedule = { ...schedule };
                        for (let i = 1; i < data.length; i++) {
                            const row = data[i];
                            const userName = row[0];
                            const user = USER_LIST.find(u => u.name === userName);
                            if (!user) continue; 
                            const userSch = { ...(newSchedule[userName] || {}) };
                            for (let j = 1; j < row.length; j++) {
                                const dateStr = headerRow[j];
                                const shiftName = row[j];
                                if (dateStr && shiftName) {
                                    const shiftId = getShiftIdByName(shiftName);
                                    if (shiftId) userSch[dateStr] = shiftId;
                                }
                            }
                            newSchedule[userName] = userSch;
                        }
                        saveToDb({ schedule: newSchedule }, false, {
                            time: new Date().toLocaleString('zh-TW'),
                            user: currentUser.name,
                            action: 'åŒ¯å…¥ Excel',
                            detail: 'æ‰¹é‡æ›´æ–°ç­è¡¨'
                        });
                        showToast("Excel åŒ¯å…¥æˆåŠŸï¼", "success");
                    } catch (err) { console.error("Import Error:", err); showToast("åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼", "error"); } finally { e.target.value = ''; }
                };
                reader.readAsBinaryString(file);
            };

            if (!currentUser) { return <LoginScreen onLogin={setCurrentUser} />; }

            return (
                <React.Fragment>
                    <input type="file" ref={fileInputRef} onChange={handleImport} accept=".xlsx, .xls" style={{ display: 'none' }} />
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

                    <header className="z-30 flex-none bg-white/90 backdrop-blur-sm shadow-sm border-b-2 border-stone-200">
                        <div className="w-full overflow-x-auto hide-scrollbar py-3 px-2">
                            <div className="flex items-center gap-3 min-w-max">
                                <div className="flex flex-col mr-2">
                                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => { if(!isConnected) showToast('å°šæœªé€£ç·šè‡³é›²ç«¯', 'error'); }}>
                                        <h1 className="text-2xl font-black text-slate-800 tracking-wider">å€¼ç­è¡¨ v4.3</h1>
                                        <div className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]' : 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]'}`} title={isConnected ? "å·²é€£ç·šè‡³é›²ç«¯" : "æœªé€£ç·š"}></div>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1">
                                        <div className="flex items-center gap-1 text-sm font-bold text-slate-800"><span className="bg-yellow-200 px-1 rounded text-xs">Hi</span>{currentUser.name}</div>
                                        <button onClick={() => setShowLogModal(true)} className="flex items-center gap-1 text-[10px] text-slate-500 hover:text-blue-600 px-2 py-0.5 bg-white border border-slate-200 rounded-lg hover:border-blue-300 transition"><ScrollTextIcon size={10} /> ç´€éŒ„</button>
                                    </div>
                                </div>
                                <div className="flex gap-2 border-r-2 border-slate-200 pr-3 mr-1">
                                    <button onClick={() => saveToDb({ schedule, rotationCycles, weekNightCycles }, true)} disabled={isSaving} className={`group relative flex flex-col items-center justify-center p-2 text-white rounded-xl border-2 btn-press active:scale-95 transition shadow-[3px_3px_0px_rgba(21,128,61,1)] ${isSaving ? 'bg-gray-400 border-gray-500 cursor-wait' : 'bg-green-500 border-green-700'}`} title="æ‰‹å‹•å­˜æª”"><SaveIcon size={20} /><span className="text-[10px] font-bold mt-0.5">{isSaving ? '...' : 'å­˜æª”'}</span></button>
                                    <button onClick={handleLogout} className="group relative flex flex-col items-center justify-center p-2 bg-slate-100 text-slate-600 rounded-xl border-2 border-slate-400 btn-press active:scale-95 transition shadow-[3px_3px_0px_rgba(148,163,184,1)] hover:bg-red-50 hover:text-red-600 hover:border-red-400 hover:shadow-[3px_3px_0px_rgba(239,68,68,1)]" title="ç™»å‡ºç³»çµ±"><LogOutIcon size={20} /><span className="text-[10px] font-bold mt-0.5">ç™»å‡º</span></button>
                                </div>
                                <div className="flex items-center bg-white border-2 border-slate-800 rounded-xl px-1 py-1">
                                    <button onClick={prevPeriod} className="p-2 hover:bg-slate-100 rounded-lg transition"><ChevronLeft size={20}/></button>
                                    <div className="px-3 font-black text-lg text-center text-slate-800 leading-tight min-w-[110px]"><span className="text-xs text-slate-400 block">Quick Nav</span></div>
                                    <button onClick={nextPeriod} className="p-2 hover:bg-slate-100 rounded-lg transition"><ChevronRight size={20}/></button>
                                </div>
                                <button onClick={goToToday} className="flex flex-col items-center justify-center px-3 py-2 text-slate-800 hover:bg-slate-100 rounded-xl border-0 btn-press active:scale-95 transition" title="å›åˆ°ä»Šå¤©"><CalendarIcon size={24} /></button>
                                <button onClick={handleExport} className="flex flex-col items-center justify-center px-3 py-2 bg-emerald-100 text-emerald-800 rounded-xl border-2 border-emerald-800 btn-press active:scale-95 transition" title="åŒ¯å‡º Excel"><DownloadIcon size={18} /><span className="text-[10px] font-bold mt-0.5">åŒ¯å‡º</span></button>
                                <button onClick={handleImportClick} className="flex flex-col items-center justify-center px-3 py-2 bg-sky-100 text-sky-800 rounded-xl border-2 border-sky-800 btn-press active:scale-95 transition" title="åŒ¯å…¥ Excel"><UploadIcon size={18} /><span className="text-[10px] font-bold mt-0.5">åŒ¯å…¥</span></button>
                                <div className="w-0.5 h-10 bg-slate-200 mx-1"></div>
                                {/* ç·¨è¼¯é– */}
                                <button 
                                    onClick={() => setIsLocked(!isLocked)} 
                                    className={`flex flex-col items-center justify-center px-3 py-2 rounded-xl border-2 transition-all duration-200 cursor-pointer select-none ${isLocked ? 'bg-red-50 text-red-600 border-red-300' : 'bg-white text-slate-600 border-slate-300 hover:border-slate-500'}`}
                                    title={isLocked ? "ç·¨è¼¯é–å®š (å”¯è®€)" : "é»æ“Šå¯ç·¨è¼¯"}
                                >
                                    {isLocked ? <LockIcon size={20} /> : <UnlockIcon size={20} />}
                                    <span className="text-[10px] font-bold mt-0.5">{isLocked ? 'é–å®š' : 'ç·¨è¼¯'}</span>
                                </button>
                                <div className="w-0.5 h-10 bg-slate-200 mx-1"></div>
                                <button onClick={() => toggleTool(TOOL_ERASER.id)} className={`group relative flex flex-row items-center justify-center gap-2 px-3 py-2 rounded-xl border-2 transition-all duration-200 cursor-pointer select-none ${selectedTool === TOOL_ERASER.id ? 'scale-105 z-10 -translate-y-1 ' + TOOL_ERASER.color.replace('border-', 'border-slate-900 ') : 'bg-white border-slate-200 hover:border-slate-800 hover:-translate-y-0.5 opacity-90 hover:opacity-100'}`}>
                                    <span className="text-xl filter drop-shadow-sm">{TOOL_ERASER.icon}</span><span className={`text-base font-bold ${selectedTool === TOOL_ERASER.id ? 'text-slate-900' : 'text-slate-700'}`}>{TOOL_ERASER.name}</span>{selectedTool === TOOL_ERASER.id && (<div className="absolute -top-2 -right-2 bg-slate-900 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center border-2 border-white">âœ“</div>)}
                                </button>
                                {Object.values(SHIFT_TYPES).filter(t => t.id !== 'REST' && t.id !== 'NORMAL').map(type => (
                                    <button key={type.id} onClick={() => toggleTool(type.id)} draggable="false" className={`group relative flex flex-row items-center justify-center gap-2 px-3 py-2 rounded-xl border-2 transition-all duration-200 cursor-pointer select-none ${selectedTool === type.id ? 'scale-105 z-10 -translate-y-1 shadow-md ' : 'bg-white hover:bg-slate-50 hover:-translate-y-0.5 opacity-90 hover:opacity-100 shadow-sm border border-slate-200'}`}>
                                        <span className="text-2xl filter drop-shadow-sm leading-none mr-1">{type.icon}</span><span className={`text-xs font-bold ${selectedTool === type.id ? 'text-slate-800' : 'text-slate-700'}`}>{type.name}</span>{selectedTool === type.id && (<div className="absolute -top-2 -right-2 bg-slate-900 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center border-2 border-white">âœ“</div>)}
                                    </button>
                                ))}
                                <div className="ml-auto pl-4 border-l-2 border-slate-200 flex flex-col items-end justify-center">
                                    {lastModifiedInfo && (<div className="text-[10px] text-slate-400 whitespace-nowrap">Update: {lastModifiedInfo.by} {lastModifiedInfo.at}</div>)}
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* ä¸»è¡¨æ ¼å€åŸŸ */}
                    <div className="flex-1 overflow-hidden relative flex flex-col">
                        <div className="flex-1 overflow-auto" ref={scrollRef}>
                            <table className="border-collapse w-full min-w-max">
                                <thead className="sticky top-0 z-20 bg-stone-50 shadow-sm">
                                    <tr>
                                        <th className="bg-stone-100 border-b border-r border-stone-300 min-w-[140px]"></th>
                                        {monthGroups.map((group, idx) => (<th key={idx} colSpan={group.count} className="bg-slate-800 text-white border-r border-slate-600 py-1 text-center font-bold text-sm tracking-wider">{group.label}</th>))}
                                    </tr>
                                    <tr>
                                        <th className="sticky left-0 z-30 bg-stone-100 border-b-2 border-r-2 border-stone-300 min-w-[140px] p-2 text-center font-black text-slate-600 text-xl tracking-widest shadow-[2px_0_5px_rgba(0,0,0,0.05)]">å§“å</th>
                                        {daysData.map(day => (
                                            <th key={day.dateStr} className={`border-b-2 border-r border-stone-200 min-w-[48px] py-2 text-center relative ${day.holiday ? 'bg-sky-50' : day.isWeekend ? 'bg-rose-50' : 'bg-white'}`}>
                                                <div className={`text-sm font-bold mb-0.5 ${day.isWeekend || day.holiday ? 'text-rose-600' : 'text-slate-500'}`}>{day.dayOfWeek}</div>
                                                <div className={`text-xl font-black leading-none ${getDateStr(new Date()) === day.dateStr ? 'text-blue-600 underline decoration-wavy decoration-2' : 'text-slate-800'}`}>
                                                    {(() => { const payday = getPayday(day.date.getFullYear(), day.date.getMonth()); if (getDateStr(day.date) === getDateStr(payday)) return 'ğŸ§'; return day.dayNum; })()}
                                                </div>
                                                {day.holiday && (<div className="absolute -bottom-2 left-0 w-full flex justify-center z-10"><span className="bg-sky-500 text-white border border-sky-700 text-[10px] px-1.5 py-0.5 rounded-full shadow-sm truncate max-w-full font-bold">{day.holiday}</span></div>)}
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {USER_LIST.map((userData) => (
                                        <tr key={userData.id} className="group/row bg-white hover:bg-yellow-50/50 transition-colors border-b border-stone-200">
                                            <td className="sticky left-0 z-10 bg-white group-hover/row:bg-yellow-50/50 border-r-2 border-stone-300 p-0 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.1)]">
                                                <div 
                                                    className="px-3 py-2 h-full group/namecell min-w-[140px] flex justify-center items-center cursor-pointer hover:bg-blue-50 transition-colors"
                                                    onClick={() => handleUserClick(userData.name)}
                                                    title="é»æ“ŠæŸ¥çœ‹çµ±è¨ˆ"
                                                >
                                                    <span className="font-bold text-slate-800 text-lg tracking-wide">{userData.name}</span>
                                                </div>
                                            </td>
                                            {daysData.map(day => {
                                                const shiftId = schedule[userData.name]?.[day.dateStr];
                                                const shift = shiftId && SHIFT_TYPES[shiftId] ? SHIFT_TYPES[shiftId] : null;
                                                const shiftLabel = getShiftLabel(shift);
                                                const isRotationUser = schedule.rotationCycles?.[userData.name]?.some(c => { const s = new Date(c.start).getTime(); const e = new Date(c.end).getTime(); const d = new Date(day.date).getTime(); return d >= s && d <= e; });
                                                const isWeekNightUser = schedule.weekNightCycles?.[userData.name]?.some(c => { const s = new Date(c.start).getTime(); const e = new Date(c.end).getTime(); const d = new Date(day.date).getTime(); return d >= s && d <= e; });
                                                let bgClass = 'bg-white';
                                                if (day.holiday) bgClass = 'bg-sky-50';
                                                else if (day.isWeekend) bgClass = 'bg-rose-50';
                                                else if (isWeekNightUser) bgClass = 'bg-purple-50';
                                                else if (isRotationUser) bgClass = 'bg-green-50';
                                                return (
                                                    <td 
                                                        key={`${userData.name}-${day.dateStr}`} 
                                                        onMouseDown={(e) => handleCellMouseDown(e, userData.name, day.dateStr)}
                                                        onMouseEnter={(e) => handleCellMouseEnter(e, userData.name, day.dateStr)}
                                                        className={`border-r border-stone-100 text-center cursor-pointer relative p-1 align-middle hover:bg-slate-100/50 active:bg-slate-200/50 ${bgClass}`}
                                                    >
                                                        {shift ? (
                                                            <div className={`w-full h-11 flex items-center justify-center font-black text-xl transition-transform hover:scale-110 hover:z-10 relative rounded-lg ${shift.color} ${shift.id === 'REST' ? 'bg-stone-100' : ''}`}>{shiftLabel}</div>
                                                        ) : (
                                                            <div className="w-full h-10 flex items-center justify-center opacity-0 hover:opacity-30">
                                                                {userData.type === 'NORMAL' && !day.isWeekend && !day.holiday && (<div className="w-1.5 h-1.5 bg-blue-200 rounded-full"></div>)}
                                                            </div>
                                                        )}
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {showLogModal && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[90] flex items-center justify-center p-4" onClick={() => setShowLogModal(false)}>
                            <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 border-2 border-slate-800 relative max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="text-xl font-black text-slate-800 flex items-center gap-2"><ScrollTextIcon size={24} className="text-blue-600" /> ä¿®æ”¹ç´€éŒ„ (æœ€è¿‘20ç­†)</h3><button onClick={() => setShowLogModal(false)}><XIcon size={24} className="text-slate-400" /></button></div>
                                <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                                    {changeLogs.length === 0 ? <p className="text-center text-slate-400 py-4">å°šç„¡ç´€éŒ„</p> : changeLogs.map((log, idx) => (
                                        <div key={idx} className="bg-slate-50 p-3 rounded-lg border border-slate-200 text-sm">
                                            <div className="flex justify-between text-xs text-slate-400 mb-1"><span>{log.time}</span><span className="font-bold text-slate-600">{log.user}</span></div>
                                            <div className="font-bold text-slate-800">{log.action}</div>
                                            <div className="text-slate-500 mt-1">{log.detail}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* User Stats Modal */}
                    {userStatsModal && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4" onClick={() => setUserStatsModal(null)}>
                            <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 border-2 border-slate-800 animate-in zoom-in-95 duration-200" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6 border-b pb-2">
                                    <h3 className="text-2xl font-black text-slate-800 flex items-center gap-2"><ChartBarIcon size={24} className="text-blue-600" />{userStatsModal.name} çµ±è¨ˆ</h3>
                                    <button onClick={() => setUserStatsModal(null)} className="p-1 text-slate-400 hover:text-slate-600"><XIcon size={24} /></button>
                                </div>
                                <div className="space-y-3 mb-6">
                                    <p className="text-sm text-slate-400 font-bold mb-2">{userStatsModal.year} å¹´å…¨å¹´åº¦çµ±è¨ˆ</p>
                                    {Object.keys(userStatsModal.stats).length === 0 ? <p className="text-center text-slate-400">æ­¤å¹´åº¦ç„¡æ’ç­ç´€éŒ„</p> : 
                                        Object.entries(userStatsModal.stats).map(([key, count]) => (
                                            <div key={key} className="flex justify-between items-center p-2 bg-slate-50 rounded-lg border border-slate-100">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-2xl">{SHIFT_TYPES[key]?.icon}</span>
                                                    <span className="font-bold text-slate-700">{SHIFT_TYPES[key]?.name}</span>
                                                </div>
                                                <span className="font-black text-xl text-slate-800">{count} <span className="text-xs text-slate-400 font-normal">å¤©</span></span>
                                            </div>
                                        ))
                                    }
                                </div>
                                <button 
                                    onClick={() => confirmClearUser(userStatsModal.name)}
                                    className="w-full py-3 bg-red-50 text-red-600 rounded-xl font-bold border-2 border-red-200 hover:bg-red-100 transition flex items-center justify-center gap-2"
                                >
                                    <Trash2 size={18} /> æ¸…é™¤æ­¤äººç´€éŒ„
                                </button>
                            </div>
                        </div>
                    )}

                    {confirmModal.show && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-lg max-w-sm w-full p-6 border-2 border-slate-800 animate-in zoom-in-95 duration-200 -rotate-1">
                                <div className={`w-14 h-14 rounded-full flex items-center justify-center mb-4 border-2 border-slate-800 ${confirmModal.isDangerous ? 'bg-red-100 text-red-500' : 'bg-blue-100 text-blue-500'}`}><AlertTriangle size={30} /></div>
                                <h3 className="text-2xl font-bold text-slate-800 mb-2">{confirmModal.title}</h3>
                                <p className="text-lg text-slate-600 mb-8 leading-relaxed">{confirmModal.msg}</p>
                                <div className="flex gap-3"><button onClick={() => setConfirmModal({ show: false })} className="flex-1 py-3 rounded-lg border-2 border-slate-300 text-slate-600 font-bold hover:bg-slate-50 transition btn-press">å–æ¶ˆ</button><button onClick={confirmModal.action} className={`flex-1 py-3 rounded-lg text-white font-bold border-2 border-slate-800 btn-press transition ${confirmModal.isDangerous ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}`}>ç¢ºå®š</button></div>
                            </div>
                        </div>
                    )}
                    {/* Cell Menu Modal - åªæœ‰åœ¨æœªé–å®šæ™‚æ‰å…è¨±é»æ“Šè§¸ç™¼ (å·²åœ¨ handleCellClick é˜»æ“‹) */}
                    {activeCell && !isLocked && (
                        <div className="fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setActiveCell(null)}>
                            <div className="bg-white rounded-xl shadow-xl p-4 w-full max-w-sm border-2 border-slate-800 animate-in zoom-in-95 duration-200" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 pb-2 border-b border-slate-200">
                                    <div className="flex flex-col"><span className="text-xs font-bold text-slate-400">ç•¶æ—¥æ’ç­è¨­å®š</span><span className="text-xl font-black text-slate-800">{activeCell.user} <span className="text-slate-400 mx-1">/</span> {activeCell.dateStr}</span></div>
                                    <button onClick={() => setActiveCell(null)} className="p-1 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100"><XIcon size={24} /></button>
                                </div>
                                <div className="grid grid-cols-3 gap-3 mb-4">
                                    {Object.values(SHIFT_TYPES).filter(t => t.id !== 'REST' && t.id !== 'NORMAL').map(type => (
                                        <button key={type.id} onClick={() => applyShiftFromModal(type.id)} className={`flex flex-col items-center justify-center p-3 rounded-xl transition-all btn-press ${activeCell.currentShift === type.id ? 'border-slate-800 bg-slate-50 ring-2 ring-slate-800 ring-offset-1' : 'border-slate-200 bg-white hover:border-slate-400'}`}>
                                            <div className="text-3xl mb-1">{type.icon}</div>
                                            <span className="text-sm font-bold text-slate-700">{type.name}</span>
                                        </button>
                                    ))}
                                </div>
                                <div className="flex gap-3 pt-2 border-t border-slate-200">
                                    <button onClick={() => applyShiftFromModal('ERASER')} className="flex-1 flex items-center justify-center gap-2 p-3 rounded-xl border-2 border-slate-300 text-slate-600 font-bold hover:bg-slate-50 btn-press"><Trash2 size={18} />æ¸…é™¤ç•¶æ—¥</button>
                                    <button onClick={openAutoFillFromCell} className="flex-1 flex items-center justify-center gap-2 p-3 rounded-xl border-2 border-slate-800 bg-yellow-100 text-slate-900 font-bold hover:bg-yellow-200 btn-press"><Zap size={18} fill="currentColor" className="text-yellow-600" />å¾æ­¤æ’ç­</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showAutoFill && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-yellow-100 rounded-lg shadow-lg max-w-sm w-full p-6 border-2 border-slate-900 relative rotate-1">
                                <button onClick={() => setShowAutoFill(false)} className="absolute -top-3 -right-3 bg-white border-2 border-slate-900 rounded-full p-1 hover:rotate-90 transition text-slate-900 shadow-sm"><XIcon size={20} /></button>
                                <h3 className="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2 border-b-2 border-slate-900 border-dashed pb-2"><Zap className="text-orange-500 fill-current" />è‡ªå‹•æ’ç­é­”æ³•</h3>
                                <div className="space-y-4">
                                    <div><label className="text-lg font-bold text-slate-700">å°è±¡èˆ‡é–‹å§‹æ—¥</label><div className="p-3 bg-white border-2 border-slate-400 rounded-lg flex justify-between items-center"><span className="font-bold text-xl text-slate-800">{targetUser}</span><span className="text-sm font-bold text-slate-500">{autoStartDate} èµ·</span></div></div>
                                    <div>
                                        <label className="text-lg font-bold text-slate-700">è¦å‰‡æ˜¯ï¼Ÿ</label>
                                        <div className="mt-1 grid grid-cols-1 gap-2">
                                            <button onClick={() => { setAutoRule('4-2'); setAutoShiftType('ROTATION_A'); }} className={`p-3 rounded-lg border-2 text-left transition-all flex items-center gap-3 btn-press ${autoRule === '4-2' ? 'border-orange-600 bg-orange-100 text-slate-900' : 'border-slate-300 bg-white text-slate-500'}`}><div className="font-bold text-lg">å››ç­äºŒè¼ª</div><div className="text-sm font-bold bg-white px-2 rounded border border-slate-300">åš2ä¼‘2</div></button>
                                            <button onClick={() => { setAutoRule('week-night'); setAutoShiftType('EVE_WEEKDAY'); }} className={`p-3 rounded-lg border-2 text-left transition-all flex items-center gap-3 btn-press ${autoRule === 'week-night' ? 'border-violet-600 bg-violet-100 text-slate-900' : 'border-slate-300 bg-white text-slate-500'}`}><div className="font-bold text-lg">å¹³æ—¥å°å¤œ</div><div className="text-sm font-bold bg-white px-2 rounded border border-slate-300">é€±å…­ä¼‘</div></button>
                                        </div>
                                    </div>
                                    <div className="mt-4 p-4 bg-white/50 rounded-lg border-2 border-slate-300 border-dashed">
                                        {autoRule === '4-2' && (<div className="animate-in fade-in slide-in-from-top-2 space-y-3"><div><label className="text-lg font-bold text-slate-700 block mb-1">å¹¾å€‹å›åˆï¼Ÿ</label><div className="flex items-center gap-2"><input type="number" min="1" max="50" value={autoRounds} onChange={e => setAutoRounds(Number(e.target.value))} className="w-20 bg-white border-2 border-slate-400 rounded p-1 text-center font-bold text-2xl text-slate-800 outline-none focus:border-slate-900" /><span className="text-lg font-bold text-slate-500">= <span className="text-slate-800">{autoRounds * 4}</span> å¤©</span></div></div><div><label className="text-lg font-bold text-slate-700 block mb-1">ç­åˆ¥</label><div className="flex gap-2">
                                            {/* AutoFill buttons updated to use new shifts */}
                                            <button onClick={() => setAutoShiftType('DAY_A')} className={`flex-1 py-2 rounded-lg text-lg font-bold border-2 btn-press ${autoShiftType === 'DAY_A' ? 'bg-green-500 text-white border-green-700' : 'bg-white text-slate-500 border-slate-300'}`}>æ—¥A</button>
                                            <button onClick={() => setAutoShiftType('DAY_B')} className={`flex-1 py-2 rounded-lg text-lg font-bold border-2 btn-press ${autoShiftType === 'DAY_B' ? 'bg-yellow-500 text-white border-yellow-700' : 'bg-white text-slate-500 border-slate-300'}`}>æ—¥B</button>
                                            <button onClick={() => setAutoShiftType('NIGHT_A')} className={`flex-1 py-2 rounded-lg text-lg font-bold border-2 btn-press ${autoShiftType === 'NIGHT_A' ? 'bg-purple-500 text-white border-purple-700' : 'bg-white text-slate-500 border-slate-300'}`}>å¤œA</button>
                                            <button onClick={() => setAutoShiftType('NIGHT_B')} className={`flex-1 py-2 rounded-lg text-lg font-bold border-2 btn-press ${autoShiftType === 'NIGHT_B' ? 'bg-indigo-500 text-white border-indigo-700' : 'bg-white text-slate-500 border-slate-300'}`}>å¤œB</button>
                                        </div></div></div>)}
                                        {autoRule === 'week-night' && (<div className="animate-in fade-in slide-in-from-top-2"><label className="text-lg font-bold text-slate-700 block mb-1">æŒçºŒå¹¾é€±ï¼Ÿ</label><div className="flex items-center gap-2"><input type="number" min="1" max="52" value={autoWeeksDuration} onChange={e => setAutoWeeksDuration(Number(e.target.value))} className="w-20 bg-white border-2 border-slate-400 rounded p-1 text-center font-bold text-2xl text-slate-800" /><span className="text-lg font-bold text-slate-500">é€±</span></div></div>)}
                                    </div>
                                </div>
                                <div className="mt-6 flex gap-3"><button onClick={() => setShowAutoFill(false)} className="flex-1 py-3 rounded-lg font-bold border-2 border-slate-400 text-slate-500 hover:bg-slate-100 transition btn-press">ç®—äº†å§</button><button onClick={runAutoFill} className="flex-1 py-3 rounded-lg font-bold border-2 border-slate-800 bg-slate-800 text-white hover:bg-slate-700 btn-press transition">å¯«å…¥ï¼</button></div>
                            </div>
                        </div>
                    )}
                </React.Fragment>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ShiftScheduleMatrix />);
    </script>
</body>
</html>
