<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­è¡¨æ‰‹å¸³ 2025-2026 (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- å¼•å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.Firebase = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken,
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot,
            collection
        };
    </script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
            -webkit-font-smoothing: antialiased;
            background-color: #FEF9E7;
            user-select: none;
            -webkit-user-select: none;
        }
        .paper-texture {
            background-color: #FEF9E7;
            background-image: radial-gradient(#E5E0C8 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .btn-press:active { transform: translateY(1px); }
        th, td { vertical-align: middle; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .toast-enter { animation: slideUp 0.3s ease-out forwards; }
        .cursor-wait { cursor: wait; opacity: 0.7; }
    </style>
</head>
<body class="paper-texture h-screen overflow-hidden text-slate-700">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, onSnapshot, collection } = window.Firebase;

        // --- SVG Icons ---
        const IconBase = ({ children, size = 20, className = "", ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const ChevronLeft = (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const XIcon = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const CalendarIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const Eraser = (props) => <IconBase {...props}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></IconBase>;
        const Hand = (props) => <IconBase {...props}><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a9 9 0 0 1 3.24-14.22"/></IconBase>;
        const SaveIcon = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const LogOutIcon = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
        const UserIcon = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const InfoIcon = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></IconBase>;
        const CheckIcon = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const BuildingIcon = (props) => <IconBase {...props}><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M16 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/></IconBase>;
        const RepeatIcon = (props) => <IconBase {...props}><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></IconBase>;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAQcIBp-giqjuOxE5D7EjelLnIpimFYDpk",
            authDomain: "otfape1.firebaseapp.com",
            projectId: "otfape1",
            storageBucket: "otfape1.firebasestorage.app",
            messagingSenderId: "19216643898",
            appId: "1:19216643898:web:cebc48af06015bcad78203"
        };
        
        const appId = 'shift-schedule-app'; 

        let db = null;
        let auth = null;
        let isConfigured = false;
        
        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isConfigured = true;
            } catch (err) {
                console.error("Firebase init failed:", err);
            }
        }

        // --- CONSTANTS ---
        const USER_LIST = [
            { id: 'v02455', name: 'å‘¨å“²ç¶­' },
            { id: 'v02457', name: 'é™³æ³“å»·' },
            { id: 'v03111', name: 'ç‹æ³“å‡±' },
            { id: 'v03282', name: 'æ¸¸ä½³æ†²' },
            { id: 'v03369', name: 'é™³å˜‰è»’' },
            { id: 'v03370', name: 'é™³æµ©éœ–' },
            { id: 'v03735', name: 'è¶™å©‰å‰' },
            { id: 'v04151', name: 'å¼µçš“ç¿”' },
            { id: 'v04457', name: 'ç¿å­æ¶µ' },
            { id: 'v04463', name: 'æ—æ˜å„’' }
        ];

        const SHIFT_TYPES = {
            NORMAL: { id: 'NORMAL', name: 'å¸¸æ—¥', time: '08:30-17:30', color: 'bg-blue-600 text-white border-blue-800', icon: 'â˜€ï¸' },
            EVE_WEEKDAY: { id: 'EVE_WEEKDAY', name: 'å¹³æ—¥å¤œ', time: '15:00-24:00', color: 'bg-violet-700 text-white border-violet-900', icon: 'ğŸŒ' },
            EVE_WEEKEND: { id: 'EVE_WEEKEND', name: 'å‡æ—¥å¤œ', time: '15:00-24:00', color: 'bg-pink-600 text-white border-pink-800', icon: 'ğŸŒš' },
            ROTATION_A: { id: 'ROTATION_A', name: 'Aç­', time: '07:20-19:20', color: 'bg-orange-500 text-white border-orange-700', icon: 'A' },
            ROTATION_B: { id: 'ROTATION_B', name: 'Bç­', time: '07:20-19:20', color: 'bg-teal-600 text-white border-teal-800', icon: 'B' },
            LEAVE: { id: 'LEAVE', name: 'è«‹å‡', time: 'OFF', color: 'bg-slate-700 text-white border-slate-900', icon: 'ğŸ”' },
            REST: { id: 'REST', name: 'ä¼‘', time: 'REST', color: 'bg-stone-200 text-stone-600 border-stone-300 border-dashed', icon: 'ğŸ’¤' }
        };

        const TOOL_ERASER = {
            id: 'ERASER', name: 'æ¸…é™¤', time: '',
            color: 'bg-white text-slate-700 border-slate-400 border-2 border-dashed', 
            icon: <Eraser size={18} />
        };

        const HOLIDAYS = {
            '2025-01-25': 'æ˜¥ç¯€', '2025-01-26': 'æ˜¥ç¯€', '2025-01-27': 'é™¤å¤•', '2025-01-28': 'æ˜¥ç¯€', '2025-01-29': 'æ˜¥ç¯€', 
            '2025-01-30': 'æ˜¥ç¯€', '2025-01-31': 'æ˜¥ç¯€', '2025-02-01': 'æ˜¥ç¯€', '2025-02-02': 'æ˜¥ç¯€',
            '2025-02-28': '228', '2025-03-01': '228', '2025-03-02': '228',
            '2025-04-03': 'å…’ç«¥', '2025-04-04': 'æ¸…æ˜', '2025-04-05': 'æ¸…æ˜', '2025-04-06': 'æ¸…æ˜',
            '2025-05-30': 'ç«¯åˆ', '2025-05-31': 'ç«¯åˆ', '2025-06-01': 'ç«¯åˆ',
            '2025-09-27': 'æ•™å¸«', '2025-09-28': 'æ•™å¸«', '2025-09-29': 'æ•™å¸«',
            '2025-10-04': 'ä¸­ç§‹', '2025-10-05': 'ä¸­ç§‹', '2025-10-06': 'ä¸­ç§‹',
            '2025-10-10': 'åœ‹æ…¶', '2025-10-11': 'åœ‹æ…¶', '2025-10-12': 'åœ‹æ…¶',
            '2025-10-24': 'å…‰å¾©', '2025-10-25': 'å…‰å¾©', '2025-10-26': 'å…‰å¾©',
            '2026-02-14': 'æ˜¥ç¯€', '2026-02-15': 'æ˜¥ç¯€', '2026-02-16': 'é™¤å¤•', '2026-02-17': 'æ˜¥ç¯€', '2026-02-18': 'æ˜¥ç¯€',
            '2026-02-19': 'æ˜¥ç¯€', '2026-02-20': 'æ˜¥ç¯€', '2026-02-21': 'æ˜¥ç¯€', '2026-02-22': 'æ˜¥ç¯€',
            '2026-02-27': '228', '2026-02-28': '228', '2026-03-01': '228',
            '2026-04-03': 'å…’ç«¥', '2026-04-04': 'æ¸…æ˜', '2026-04-05': 'æ¸…æ˜', '2026-04-06': 'æ¸…æ˜',
            '2026-05-01': 'å‹å‹•', '2026-05-02': 'å‹å‹•', '2026-05-03': 'å‹å‹•',
            '2026-06-19': 'ç«¯åˆ', '2026-06-20': 'ç«¯åˆ', '2026-06-21': 'ç«¯åˆ',
            '2026-09-25': 'ä¸­ç§‹', '2026-09-26': 'ä¸­ç§‹', '2026-09-27': 'æ•™å¸«', '2026-09-28': 'æ•™å¸«',
            '2026-10-09': 'åœ‹æ…¶', '2026-10-10': 'åœ‹æ…¶', '2026-10-11': 'åœ‹æ…¶',
            '2026-10-24': 'å…‰å¾©', '2026-10-25': 'å…‰å¾©', '2026-10-26': 'å…‰å¾©',
            '2026-12-25': 'è¡Œæ†²', '2026-12-26': 'è¡Œæ†²', '2026-12-27': 'è¡Œæ†²',
        };

        const getDateStr = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const isWeekend = (date) => {
            const day = date.getDay();
            return day === 0 || day === 6;
        };

        const getShiftLabel = (shift) => {
            if (!shift) return '';
            if (shift.id === 'LEAVE') return shift.icon;
            if (shift.id === 'REST') return shift.icon;
            if (shift.id === 'EVE_WEEKDAY') return shift.icon;
            if (shift.id === 'EVE_WEEKEND') return shift.icon;
            if (shift.id === 'ROTATION_A') return shift.icon;
            if (shift.id === 'ROTATION_B') return shift.icon;
            if (shift.id === 'NORMAL') return shift.icon;
            return shift.name[0];
        };

        // --- Helper: Calculate Payday for a month ---
        const getPayday = (year, month) => {
            let d = new Date(year, month, 25);
            // If 25th is weekend or holiday, move backward
            while (true) {
                const dateStr = getDateStr(d);
                const dayOfWeek = d.getDay();
                const isWknd = dayOfWeek === 0 || dayOfWeek === 6;
                const isHol = !!HOLIDAYS[dateStr];
                
                if (!isWknd && !isHol) {
                    return d;
                }
                d.setDate(d.getDate() - 1);
            }
        };

        // --- TOAST COMPONENT ---
        function Toast({ message, type = 'info', onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColors = {
                info: 'bg-slate-800 text-white',
                success: 'bg-green-600 text-white',
                error: 'bg-red-600 text-white',
                warning: 'bg-yellow-500 text-white'
            };

            return (
                <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-xl z-[100] text-sm font-bold flex items-center gap-2 toast-enter ${bgColors[type]}`}>
                    {type === 'error' && <AlertTriangle size={16} />}
                    {type === 'success' && <CheckIcon size={16} />}
                    {message}
                </div>
            );
        }

        // --- LOGIN COMPONENT ---
        function LoginScreen({ onLogin }) {
            const [inputId, setInputId] = useState('');
            const [error, setError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                const user = USER_LIST.find(u => u.id.toLowerCase() === inputId.toLowerCase());
                if (user) {
                    onLogin(user);
                } else {
                    setError('å·¥è™ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ (ä¾‹å¦‚ v03111)');
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 paper-texture">
                    <div className="bg-white p-8 rounded-2xl shadow-xl border-4 border-slate-800 w-full max-w-sm animate-fade-in text-center">
                        <div className="w-20 h-20 bg-yellow-300 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-slate-800 shadow-[4px_4px_0px_rgba(0,0,0,1)]">
                            <UserIcon size={40} className="text-slate-800" />
                        </div>
                        <h2 className="text-2xl font-black text-slate-800 mb-2">ç­è¡¨æ‰‹å¸³ç™»å…¥</h2>
                        <p className="text-slate-500 mb-6 text-sm">è«‹è¼¸å…¥æ‚¨çš„ 6 ç¢¼å·¥è™Ÿä»¥é–‹å§‹ä½¿ç”¨</p>
                        
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input 
                                type="text" 
                                placeholder="å·¥è™Ÿ (ä¾‹å¦‚: v03111)"
                                value={inputId}
                                onChange={(e) => {
                                    setInputId(e.target.value);
                                    setError('');
                                }}
                                className="w-full text-center text-xl font-bold p-3 rounded-xl border-2 border-slate-300 focus:border-slate-800 focus:ring-0 outline-none transition-colors"
                                maxLength={6}
                            />
                            {error && <p className="text-red-500 text-sm font-bold animate-pulse">{error}</p>}
                            
                            <button 
                                type="submit"
                                className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold text-lg hover:bg-slate-700 transition-transform active:scale-95 shadow-[4px_4px_0px_rgba(0,0,0,0.2)]"
                            >
                                é€²å…¥ç³»çµ±
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- APP COMPONENT ---
        function ShiftScheduleMatrix() {
            const [currentUser, setCurrentUser] = useState(null); 
            const [viewStartDate, setViewStartDate] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() - 7); 
                return d;
            });

            const [schedule, setSchedule] = useState({});
            const [rotationCycles, setRotationCycles] = useState({}); 
            const [weekNightCycles, setWeekNightCycles] = useState({}); // { [userName]: [{start: 'YYYY-MM-DD', end: 'YYYY-MM-DD'}] }
            const [lastModifiedInfo, setLastModifiedInfo] = useState(null); 
            const [selectedTool, setSelectedTool] = useState(null); 
            const scrollRef = useRef(null);
            const [activeCell, setActiveCell] = useState(null); 
            const [showAutoFill, setShowAutoFill] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ show: false, title: '', msg: '', action: null, isDangerous: false });
            const [logoutModal, setLogoutModal] = useState(false);
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [toast, setToast] = useState(null); 
            
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [isSaving, setIsSaving] = useState(false); 
            const [isConnected, setIsConnected] = useState(false);
            const [permissionError, setPermissionError] = useState(false);

            const [targetUser, setTargetUser] = useState(USER_LIST[0].name);
            const [autoStartDate, setAutoStartDate] = useState(getDateStr(new Date()));
            const [autoRule, setAutoRule] = useState('4-2');
            const [autoShiftType, setAutoShiftType] = useState('ROTATION_A');
            const [autoRounds, setAutoRounds] = useState(8); 
            const [autoWeeksDuration, setAutoWeeksDuration] = useState(1);

            const showToast = (message, type = 'info') => {
                setToast({ message, type });
            };

            // --- Firebase Auth & Sync ---
            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth failed:", error);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setFirebaseUser(user);
                    setIsConnected(!!user);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isConfigured) return;
                if (!firebaseUser || !db) return;
                
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shift_schedule_team', 'shared_matrix');
                
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    setPermissionError(false); 
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setSchedule(data.schedule || {});
                        setRotationCycles(data.rotationCycles || {});
                        setWeekNightCycles(data.weekNightCycles || {});
                        if (data.lastModifiedBy && data.lastModifiedAt) {
                            setLastModifiedInfo({
                                by: data.lastModifiedBy,
                                at: data.lastModifiedAt
                            });
                        }
                    } else {
                        setDoc(docRef, { schedule: {}, rotationCycles: {}, weekNightCycles: {} }, { merge: true });
                    }
                }, (error) => {
                    console.error("Sync error:", error);
                    setIsConnected(false);
                    if (error.code === 'permission-denied') {
                        setPermissionError(true);
                    } else {
                        showToast("è³‡æ–™åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯", "error");
                    }
                });

                return () => unsubscribe();
            }, [firebaseUser]);

            const saveToDb = (newData = {}, isManual = false) => {
                return new Promise(async (resolve) => {
                    const newSchedule = newData.schedule !== undefined ? newData.schedule : schedule;
                    const newRotationCycles = newData.rotationCycles !== undefined ? newData.rotationCycles : rotationCycles;
                    const newWeekNightCycles = newData.weekNightCycles !== undefined ? newData.weekNightCycles : weekNightCycles;

                    if (!isConfigured) {
                        setSchedule(newSchedule);
                        setRotationCycles(newRotationCycles);
                        setWeekNightCycles(newWeekNightCycles);
                        if (isManual) showToast("å°šæœªè¨­å®šè³‡æ–™åº«ï¼Œåƒ…æš«å­˜æ–¼æœ¬æ©Ÿ", "warning");
                        resolve(true);
                        return;
                    }

                    if (!auth || !firebaseUser) {
                        if (isManual) showToast("å°šæœªé€£ç·šï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¨­å®š", "error");
                        signInAnonymously(auth).catch(e => console.error(e));
                        resolve(false);
                        return;
                    }
                    
                    if (!db) {
                         if (isManual) showToast("è³‡æ–™åº«æœªåˆå§‹åŒ–", "error");
                         resolve(false);
                         return;
                    }

                    setIsSaving(true);
                    setPermissionError(false); 
                    
                    const timeoutPromise = new Promise(r => setTimeout(() => r('TIMEOUT'), 15000)); 
                    
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shift_schedule_team', 'shared_matrix');
                    const now = new Date();
                    const timeString = `${now.getMonth() + 1}/${now.getDate()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    
                    const dataToSave = { 
                        schedule: newSchedule,
                        rotationCycles: newRotationCycles,
                        weekNightCycles: newWeekNightCycles,
                        lastModifiedBy: currentUser ? currentUser.name : 'Unknown',
                        lastModifiedAt: timeString
                    };

                    try {
                        const result = await Promise.race([
                            setDoc(docRef, dataToSave, { merge: true }),
                            timeoutPromise
                        ]);

                        if (result === 'TIMEOUT') {
                            throw new Error("Save timeout");
                        }

                        setSchedule(newSchedule);
                        setRotationCycles(newRotationCycles);
                        setWeekNightCycles(newWeekNightCycles);
                        if (isManual) showToast("å„²å­˜æˆåŠŸï¼", "success");
                        resolve(true);
                    } catch (e) {
                        console.error("Save error:", e);
                        if (e.code === 'permission-denied') {
                            setPermissionError(true); 
                            if (isManual) showToast("å„²å­˜å¤±æ•—ï¼šæ¬Šé™ä¸è¶³ (Permission Denied)", "error");
                        } else if (e.message === "Save timeout") {
                             if (isManual) showToast("é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ³", "warning");
                        } else {
                             if (isManual) showToast(`å„²å­˜å¤±æ•—: ${e.message}`, "error");
                        }
                        resolve(false);
                    } finally {
                        setIsSaving(false);
                    }
                });
            };

            // Handlers
            const prevPeriod = () => setViewStartDate(prev => { const d = new Date(prev); d.setDate(d.getDate() - 14); return d; });
            const nextPeriod = () => setViewStartDate(prev => { const d = new Date(prev); d.setDate(d.getDate() + 14); return d; });
            const goToToday = () => { const d = new Date(); d.setDate(d.getDate() - 7); setViewStartDate(d); };

            const handleLogout = () => {
                setLogoutModal(true);
            };

            const confirmLogoutAndSave = async () => {
                const success = await saveToDb({ schedule, rotationCycles, weekNightCycles }, false);
                if (success) {
                    setCurrentUser(null);
                    setSelectedTool(null);
                    setLogoutModal(false);
                } else {
                    if (confirm("âš ï¸ å­˜æª”å¤±æ•—æˆ–é€¾æ™‚ã€‚ç¢ºå®šè¦å¼·åˆ¶ç™»å‡ºå—ï¼Ÿ(æœªå„²å­˜çš„è®Šæ›´å°‡æœƒéºå¤±)")) {
                        setCurrentUser(null);
                        setSelectedTool(null);
                        setLogoutModal(false);
                    }
                }
            };

            const confirmLogoutOnly = () => {
                setCurrentUser(null);
                setSelectedTool(null);
                setLogoutModal(false);
            };

            const handleCellClick = (userName, dateStr) => {
                if (!selectedTool) {
                    const currentShift = schedule[userName]?.[dateStr];
                    setActiveCell({ user: userName, dateStr, currentShift });
                    return;
                }

                const newSchedule = { ...schedule };
                const userSchedule = { ...(newSchedule[userName] || {}) };
                
                if (selectedTool === 'ERASER') {
                    delete userSchedule[dateStr];
                } else {
                    userSchedule[dateStr] = selectedTool;
                }
                newSchedule[userName] = userSchedule;
                saveToDb({ schedule: newSchedule });
            };

            const toggleTool = (toolId) => {
                if (selectedTool === toolId) setSelectedTool(null); 
                else setSelectedTool(toolId); 
            };

            const applyShiftFromModal = (shiftId) => {
                if (!activeCell) return;
                const { user, dateStr } = activeCell;
                const newSchedule = { ...schedule };
                const userSchedule = { ...(newSchedule[user] || {}) };

                if (shiftId === 'ERASER') {
                    delete userSchedule[dateStr];
                } else {
                    userSchedule[dateStr] = shiftId;
                }
                newSchedule[user] = userSchedule;
                saveToDb({ schedule: newSchedule });
                setActiveCell(null);
            };

            const openAutoFillFromCell = () => {
                if (!activeCell) return;
                setTargetUser(activeCell.user);
                setAutoStartDate(activeCell.dateStr);
                setActiveCell(null);
                setShowAutoFill(true);
            };

            const confirmClearUser = (userName) => {
                setConfirmModal({
                    show: true, title: `æ¸…é™¤ ${userName} çš„ç´€éŒ„`, msg: `ç¢ºå®šè¦æ¸…é™¤è©²äººå“¡çš„æ‰€æœ‰æ’ç­ç´€éŒ„å—ï¼Ÿ\n(æ³¨æ„ï¼šä¸æœƒæ¸…é™¤ 4-2 è¼ªç­èˆ‡å¹³æ—¥å°å¤œçš„é€±æœŸèƒŒæ™¯)`, isDangerous: true,
                    action: () => {
                        const newSchedule = { ...schedule };
                        delete newSchedule[userName];
                        // é€™è£¡ä¸åˆªé™¤ rotationCycles å’Œ weekNightCyclesï¼Œä¿ç•™é€±æœŸèƒŒæ™¯
                        saveToDb({ schedule: newSchedule });
                        setConfirmModal({ show: false });
                    }
                });
            };

            const runAutoFill = () => {
                const start = new Date(autoStartDate);
                if (isNaN(start.getTime())) return;
                
                let end = new Date(start);
                let endDateStr = '';

                if (autoRule === '4-2') {
                    const totalDays = autoRounds * 4;
                    const endDateObj = new Date(start);
                    endDateObj.setDate(start.getDate() + totalDays - 1); 
                    endDateStr = getDateStr(endDateObj);
                } else if (autoRule === 'week-night') {
                    const endDateObj = new Date(start);
                    endDateObj.setDate(start.getDate() + (autoWeeksDuration * 7) - 1);
                    endDateStr = getDateStr(endDateObj);
                    end = endDateObj; 
                } 

                const newSchedule = { ...schedule };
                const userSch = { ...(newSchedule[targetUser] || {}) };
                let current = new Date(start);

                if (autoRule === '4-2') {
                    const newCycles = { ...rotationCycles };
                    const userCycles = newCycles[targetUser] || [];
                    userCycles.push({ start: autoStartDate, end: endDateStr });
                    newCycles[targetUser] = userCycles;

                    const totalDays = autoRounds * 4;
                    for (let i = 0; i < totalDays; i++) {
                        let d = new Date(start);
                        d.setDate(start.getDate() + i);
                        const dStr = getDateStr(d);
                        
                        if (i % 4 < 2) {
                            userSch[dStr] = autoShiftType;
                        } else {
                            userSch[dStr] = 'REST'; 
                        }
                    }
                    
                    newSchedule[targetUser] = userSch;
                    saveToDb({ schedule: newSchedule, rotationCycles: newCycles });

                } else if (autoRule === 'week-night') {
                    // 1. Update Week Night Cycles for Visuals
                    const newWNCycles = { ...weekNightCycles };
                    const userWNCycles = newWNCycles[targetUser] || [];
                    userWNCycles.push({ start: autoStartDate, end: endDateStr });
                    newWNCycles[targetUser] = userWNCycles;

                    const endLoop = new Date(start);
                    endLoop.setDate(start.getDate() + (autoWeeksDuration * 7));

                    while (current < endLoop) {
                        const day = current.getDay();
                        if (day !== 6) { 
                            userSch[getDateStr(current)] = 'EVE_WEEKDAY';
                        }
                        current.setDate(current.getDate() + 1);
                    }
                    newSchedule[targetUser] = userSch;
                    saveToDb({ schedule: newSchedule, weekNightCycles: newWNCycles });
                }

                setShowAutoFill(false);
            };

            const isDateInRotationCycle = (user, date) => {
                const cycles = rotationCycles[user];
                if (!cycles) return false;
                const d = new Date(date).getTime();
                return cycles.some(cycle => {
                    const s = new Date(cycle.start).getTime();
                    const e = new Date(cycle.end).getTime();
                    return d >= s && d <= e;
                });
            };

            const isDateInWeekNightCycle = (user, date) => {
                const cycles = weekNightCycles[user];
                if (!cycles) return false;
                const d = new Date(date).getTime();
                return cycles.some(cycle => {
                    const s = new Date(cycle.start).getTime();
                    const e = new Date(cycle.end).getTime();
                    return d >= s && d <= e;
                });
            };

            const days = (() => {
                const arr = [];
                for (let i = 0; i < 30; i++) {
                    const date = new Date(viewStartDate);
                    date.setDate(viewStartDate.getDate() + i);
                    const dateStr = getDateStr(date);
                    arr.push({
                        date, dateStr, dayNum: date.getDate(),
                        dayOfWeek: ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][date.getDay()],
                        isWeekend: isWeekend(date),
                        holiday: HOLIDAYS[dateStr]
                    });
                }
                return arr;
            })();

            if (!currentUser) {
                return <LoginScreen onLogin={setCurrentUser} />;
            }

            return (
                <React.Fragment>
                    {/* Toast Container */}
                    {toast && (
                        <Toast 
                            message={toast.message} 
                            type={toast.type} 
                            onClose={() => setToast(null)} 
                        />
                    )}

                    {/* æ¬Šé™éŒ¯èª¤æç¤ºModal */}
                    {permissionError && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[999] flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 border-l-8 border-red-500">
                                <div className="flex items-center gap-3 mb-4 text-red-600">
                                    <AlertTriangle size={32} />
                                    <h3 className="text-xl font-black">è³‡æ–™åº«æ¬Šé™ä¸è¶³</h3>
                                </div>
                                <p className="text-slate-600 mb-4 leading-relaxed">
                                    æ‚¨çš„ Firebase Firestore å®‰å…¨è¦å‰‡ç›®å‰è¨­ç‚ºç¦æ­¢å¯«å…¥ã€‚<br/>
                                    è«‹å‰å¾€ Firebase Console å°‡è¦å‰‡ä¿®æ”¹ç‚ºå…è¨±å­˜å–ã€‚
                                </p>
                                <div className="bg-slate-100 p-3 rounded font-mono text-xs text-slate-700 mb-6 border border-slate-300 overflow-x-auto">
                                    allow read, write: if true;
                                </div>
                                <button 
                                    onClick={() => window.location.reload()}
                                    className="w-full py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg hover:bg-red-700 transition"
                                >
                                    æˆ‘å·²ä¿®æ­£è¦å‰‡ï¼Œé‡æ–°è¼‰å…¥
                                </button>
                            </div>
                        </div>
                    )}

                    {/* æœªè¨­å®š Firebase çš„æç¤º */}
                    {!isConfigured && (
                        <div className="bg-red-500 text-white text-center text-xs py-1">
                            å°šæœªè¨­å®š Firebaseï¼Œè³‡æ–™å°‡ç„¡æ³•å„²å­˜ã€‚è«‹ç·¨è¼¯ HTML æª”æ¡ˆå¡«å…¥è¨­å®šã€‚
                        </div>
                    )}

                    {/* é ‚éƒ¨æ§åˆ¶å€ */}
                    <header className="z-30 flex-none bg-white/90 backdrop-blur-sm shadow-sm border-b-2 border-stone-200">
                        <div className="w-full overflow-x-auto hide-scrollbar py-3 px-2">
                            <div className="flex items-center gap-3 min-w-max">
                                
                                {/* æ¨™é¡Œ + é€£ç·šç‹€æ…‹ */}
                                <div className="flex flex-col mr-2 cursor-pointer" onClick={() => { if(!isConnected) showToast('å°šæœªé€£ç·šè‡³é›²ç«¯', 'error'); }}>
                                    <div className="flex items-center gap-2">
                                        <h1 className="text-2xl font-black text-slate-800 tracking-wider">ç­è¡¨æ‰‹å¸³</h1>
                                        {/* é€£ç·šç‡ˆè™Ÿ */}
                                        <div className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]' : 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]'}`} title={isConnected ? "å·²é€£ç·šè‡³é›²ç«¯" : "æœªé€£ç·š"}></div>
                                    </div>
                                </div>

                                {/* 0. å·¦å´æŒ‰éˆ•å€ (å­˜æª” + ç™»å‡º) */}
                                <div className="flex gap-2 border-r-2 border-slate-200 pr-3 mr-1">
                                    <button 
                                        onClick={() => saveToDb({ schedule, rotationCycles, weekNightCycles }, true)} 
                                        disabled={isSaving}
                                        className={`group relative flex flex-col items-center justify-center p-2 text-white rounded-xl border-2 btn-press active:scale-95 transition shadow-[3px_3px_0px_rgba(21,128,61,1)]
                                            ${isSaving ? 'bg-gray-400 border-gray-500 cursor-wait' : 'bg-green-500 border-green-700'}
                                        `}
                                        title="æ‰‹å‹•å­˜æª”"
                                    >
                                        <SaveIcon size={20} />
                                        <span className="text-[10px] font-bold mt-0.5">
                                            {isSaving ? '...' : 'å­˜æª”'}
                                        </span>
                                    </button>

                                    <button 
                                        onClick={handleLogout} 
                                        className="group relative flex flex-col items-center justify-center p-2 bg-slate-100 text-slate-600 rounded-xl border-2 border-slate-400 btn-press active:scale-95 transition shadow-[3px_3px_0px_rgba(148,163,184,1)] hover:bg-red-50 hover:text-red-600 hover:border-red-400 hover:shadow-[3px_3px_0px_rgba(239,68,68,1)]"
                                        title="ç™»å‡ºç³»çµ±"
                                    >
                                        <LogOutIcon size={20} />
                                        <span className="text-[10px] font-bold mt-0.5">ç™»å‡º</span>
                                    </button>
                                </div>

                                {/* 1. æ—¥æœŸå°èˆª */}
                                <div className="flex items-center bg-white border-2 border-slate-800 rounded-xl px-1 py-1">
                                    <button onClick={prevPeriod} className="p-2 hover:bg-slate-100 rounded-lg transition"><ChevronLeft size={20}/></button>
                                    <div className="px-3 font-black text-lg text-center text-slate-800 leading-tight min-w-[110px]">
                                        {viewStartDate.getFullYear()}.<span className="text-2xl text-orange-600 ml-1">{viewStartDate.getMonth() + 1}</span>
                                        <span className="text-xs text-slate-400 block -mt-1">{viewStartDate.getDate()}æ—¥èµ·</span>
                                    </div>
                                    <button onClick={nextPeriod} className="p-2 hover:bg-slate-100 rounded-lg transition"><ChevronRight size={20}/></button>
                                </div>

                                {/* 2. å›åˆ°ä»Šå¤© */}
                                <button onClick={goToToday} className="flex flex-col items-center justify-center px-3 py-2 text-slate-800 hover:bg-slate-100 rounded-xl border-0 btn-press active:scale-95 transition" title="å›åˆ°ä»Šå¤©">
                                    <CalendarIcon size={24} />
                                </button>
                                
                                {/* 2.5. è¦å‰‡èªªæ˜æŒ‰éˆ• */}
                                <button 
                                    onClick={() => setShowInfoModal(true)} 
                                    className="flex flex-col items-center justify-center px-3 py-2 bg-blue-100 text-blue-800 rounded-xl border-2 border-blue-800 btn-press active:scale-95 transition"
                                    title="æŸ¥çœ‹æ’ç­è¦å‰‡"
                                >
                                    <InfoIcon size={18} />
                                    <span className="text-[10px] font-bold mt-0.5">è¦å‰‡</span>
                                </button>

                                {/* åˆ†éš”ç·š */}
                                <div className="w-0.5 h-10 bg-slate-200 mx-1"></div>

                                {/* 3. æ¸…é™¤æŒ‰éˆ• (ERASER) - æœ€å‰é¢ */}
                                <button
                                    onClick={() => toggleTool(TOOL_ERASER.id)}
                                    className={`
                                        group relative flex flex-row items-center justify-center gap-2 px-3 py-2 rounded-xl border-2 transition-all duration-200 cursor-pointer select-none
                                        ${selectedTool === TOOL_ERASER.id 
                                        ? 'scale-105 z-10 -translate-y-1 ' + TOOL_ERASER.color.replace('border-', 'border-slate-900 ') 
                                        : 'bg-white border-slate-200 hover:border-slate-800 hover:-translate-y-0.5 opacity-90 hover:opacity-100'}
                                    `}
                                >
                                    <span className="text-xl filter drop-shadow-sm">{TOOL_ERASER.icon}</span>
                                    <span className={`text-base font-bold ${selectedTool === TOOL_ERASER.id ? 'text-slate-900' : 'text-slate-700'}`}>
                                        {TOOL_ERASER.name}
                                    </span>
                                    {selectedTool === TOOL_ERASER.id && (
                                    <div className="absolute -top-2 -right-2 bg-slate-900 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center border-2 border-white">âœ“</div>
                                    )}
                                </button>

                                {/* 4. ç­åˆ¥å·¥å…· (ä¸å«å¸¸æ—¥) */}
                                {Object.values(SHIFT_TYPES).filter(t => t.id !== 'REST' && t.id !== 'NORMAL').map(type => (
                                    <button
                                        key={type.id}
                                        onClick={() => toggleTool(type.id)}
                                        draggable="false"
                                        className={`
                                            group relative flex flex-row items-center justify-center gap-2 px-3 py-2 rounded-xl border-2 transition-all duration-200 cursor-pointer select-none
                                            ${selectedTool === type.id 
                                            ? 'scale-105 z-10 -translate-y-1 ' + type.color.replace('border-', 'border-slate-900 ') 
                                            : 'bg-white border-slate-200 hover:border-slate-800 hover:-translate-y-0.5 opacity-90 hover:opacity-100'}
                                        `}
                                    >
                                        <span className="text-xl filter drop-shadow-sm">{type.icon}</span>
                                        <span className={`text-base font-bold ${selectedTool === type.id ? 'text-white' : 'text-slate-700'}`}>
                                            {type.name}
                                        </span>
                                        {selectedTool === type.id && (
                                        <div className="absolute -top-2 -right-2 bg-slate-900 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center border-2 border-white">âœ“</div>
                                        )}
                                    </button>
                                ))}

                                {/* å³å´è³‡è¨Šï¼šæœ€å¾Œç·¨è¼¯ */}
                                <div className="ml-auto pl-4 border-l-2 border-slate-200 flex flex-col items-end">
                                    <div className="flex items-center gap-1 text-sm font-bold text-slate-800">
                                        <span className="bg-yellow-200 px-1 rounded text-xs">Hi</span>
                                        {currentUser.name}
                                    </div>
                                    {lastModifiedInfo && (
                                        <div className="text-[10px] text-slate-400 whitespace-nowrap">
                                            Update: {lastModifiedInfo.by} {lastModifiedInfo.at}
                                        </div>
                                    )}
                                </div>

                            </div>
                        </div>
                    </header>

                    {/* ä¸»è¡¨æ ¼å€åŸŸ */}
                    <div className="flex-1 overflow-hidden relative flex flex-col">
                        <div className="flex-1 overflow-auto" ref={scrollRef}>
                            <table className="border-collapse w-full min-w-max">
                                <thead className="sticky top-0 z-20 bg-stone-50 shadow-sm">
                                    <tr>
                                        <th className="sticky left-0 z-30 bg-stone-100 border-b-2 border-r-2 border-stone-300 min-w-[140px] p-2 text-center font-black text-slate-600 text-xl tracking-widest shadow-[2px_0_5px_rgba(0,0,0,0.05)]">
                                            å§“å/ç‹€æ…‹
                                        </th>
                                        {days.map(day => (
                                            <th key={day.dateStr} className={`
                                                border-b-2 border-r border-stone-200 min-w-[48px] py-2 text-center relative
                                                ${day.holiday ? 'bg-sky-100' : (day.isWeekend ? 'bg-rose-50' : 'bg-white')}
                                            `}>
                                                <div className={`text-sm font-bold mb-0.5 ${day.isWeekend || day.holiday ? 'text-rose-600' : 'text-slate-500'}`}>
                                                    {day.dayOfWeek}
                                                </div>
                                                <div className={`
                                                    text-xl font-black leading-none
                                                    ${getDateStr(new Date()) === day.dateStr ? 'text-blue-600 underline decoration-wavy decoration-2' : 'text-slate-800'}
                                                `}>
                                                    {/* ç™¼è–ªæ—¥é‚è¼¯ï¼šå¦‚æœé€™å¤©æ˜¯è©²æœˆçš„ç™¼è–ªæ—¥ï¼Œé¡¯ç¤º ğŸ§ */}
                                                    {(() => {
                                                        const payday = getPayday(day.date.getFullYear(), day.date.getMonth());
                                                        if (getDateStr(day.date) === getDateStr(payday)) {
                                                            return 'ğŸ§';
                                                        }
                                                        return day.dayNum;
                                                    })()}
                                                </div>
                                                {day.holiday && (
                                                    <div className="absolute -bottom-2 left-0 w-full flex justify-center z-10">
                                                        <span className="bg-sky-500 text-white border border-sky-700 text-[10px] px-1.5 py-0.5 rounded-full shadow-sm truncate max-w-full font-bold">
                                                            {day.holiday}
                                                        </span>
                                                    </div>
                                                )}
                                            </th>
                                        ))}
                                    </tr>
                                    <tr className="bg-stone-100 border-b-2 border-stone-300">
                                        <th className="sticky left-0 z-30 bg-stone-200 border-r-2 border-stone-300 p-2 font-bold text-sm text-slate-600 text-center shadow-[2px_0_5px_rgba(0,0,0,0.05)]">
                                            äººåŠ›é…ç½®
                                        </th>
                                        {days.map(day => {
                                            let currentCount = 0;
                                            USER_LIST.forEach(u => {
                                                const s = schedule[u.name]?.[day.dateStr];
                                                
                                                // 1. é¡¯æ€§æ’ç­ï¼šåªè¦æœ‰æ’ç­ï¼ˆé™¤äº†ä¼‘å‡é¡ï¼‰ï¼Œå°±ç®—äººåŠ›
                                                if (s) {
                                                    if (['EVE_WEEKDAY', 'EVE_WEEKEND', 'ROTATION_A', 'ROTATION_B', 'NORMAL'].includes(s)) {
                                                        currentCount++;
                                                    }
                                                } 
                                                // 2. éš±æ€§æ’ç­ï¼šæ ¼å­ç©ºç™½ = å¹³æ—¥ä¸Šç­ (æ‰€æœ‰äººéƒ½é©ç”¨)
                                                else {
                                                    if (!day.isWeekend && !day.holiday) {
                                                        currentCount++;
                                                    }
                                                }
                                            });
                                            
                                            return (
                                                <th key={`sum-${day.dateStr}`} className="border-r border-stone-300 text-center py-1 bg-stone-100">
                                                    <span className={`text-lg font-bold ${currentCount > 0 ? 'text-slate-800' : 'text-slate-300'}`}>
                                                        {currentCount || '-'}
                                                    </span>
                                                </th>
                                            );
                                        })}
                                    </tr>
                                </thead>
                                <tbody>
                                    {USER_LIST.map((userData, idx) => {
                                        return (
                                            <tr key={userData.id} className="group/row bg-white hover:bg-yellow-50/50 transition-colors border-b border-stone-200">
                                                <td className="sticky left-0 z-10 bg-white group-hover/row:bg-yellow-50/50 border-r-2 border-stone-300 p-0 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.1)]">
                                                    <div className="px-3 py-2 h-full group/namecell min-w-[140px] flex flex-col justify-center">
                                                        <div className="flex items-center justify-between w-full">
                                                            <span className="font-bold text-slate-800 text-lg tracking-wide">
                                                                {userData.name}
                                                            </span>
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); confirmClearUser(userData.name); }}
                                                                className="w-6 h-6 flex items-center justify-center text-slate-300 hover:text-red-600 hover:bg-red-50 rounded-full transition-all"
                                                                title="æ“¦æ‰ç´€éŒ„"
                                                            >
                                                                <Trash2 size={14} />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </td>
                                                {days.map(day => {
                                                    const shiftId = schedule[userData.name]?.[day.dateStr];
                                                    const shift = shiftId && SHIFT_TYPES[shiftId] ? SHIFT_TYPES[shiftId] : null;
                                                    const shiftLabel = getShiftLabel(shift);
                                                    
                                                    // æª¢æŸ¥æ˜¯å¦åœ¨é€±æœŸå…§ï¼Œè¨­å®šä¸åŒåº•è‰²
                                                    const isRotationUser = schedule.rotationCycles?.[userData.name]?.some(cycle => {
                                                        const s = new Date(cycle.start).getTime();
                                                        const e = new Date(cycle.end).getTime();
                                                        const d = new Date(day.date).getTime();
                                                        return d >= s && d <= e;
                                                    });
                                                    const isWeekNightUser = schedule.weekNightCycles?.[userData.name]?.some(cycle => {
                                                        const s = new Date(cycle.start).getTime();
                                                        const e = new Date(cycle.end).getTime();
                                                        const d = new Date(day.date).getTime();
                                                        return d >= s && d <= e;
                                                    });
                                                    
                                                    // èƒŒæ™¯è‰²é‚è¼¯: å‡æ—¥è— > é€±æœ«ç´… > å¹³æ—¥å°å¤œé€±æœŸç´« > è¼ªç­é€±æœŸç¶  > é è¨­ç™½
                                                    let bgClass = 'bg-white';
                                                    if (day.holiday) bgClass = 'bg-sky-100';
                                                    else if (day.isWeekend) bgClass = 'bg-rose-50';
                                                    else if (isWeekNightUser) bgClass = 'bg-purple-50';
                                                    else if (isRotationUser) bgClass = 'bg-green-50';

                                                    return (
                                                        <td 
                                                            key={`${userData.name}-${day.dateStr}`}
                                                            onClick={() => handleCellClick(userData.name, day.dateStr)}
                                                            className={`
                                                                border-r border-stone-100 text-center cursor-pointer relative p-1 align-middle
                                                                hover:bg-slate-100/50 active:bg-slate-200/50
                                                                ${bgClass}
                                                            `}
                                                        >
                                                            {shift ? (
                                                                <div className={`
                                                                    w-full h-11 flex items-center justify-center font-black text-xl border-2 transition-transform hover:scale-110 hover:z-10 relative
                                                                    ${shift.color} 
                                                                    ${shift.id === 'LEAVE' || shift.id === 'NORMAL' ? 'rounded-md' : 'rounded-full'} 
                                                                    ${shift.id === 'REST' ? 'bg-stone-200 border-stone-300 text-stone-500 border-dashed' : ''}
                                                                `} style={{borderRadius: shift.id.includes('ROTATION') || shift.id === 'REST' ? '50%' : '8px'}}>
                                                                    {shiftLabel}
                                                                </div>
                                                            ) : (
                                                                <div className="w-full h-10 flex items-center justify-center opacity-0 hover:opacity-30">
                                                                    {/* éš±æ€§ä¸Šç­é» (å¹³æ—¥éå‡æ—¥) */}
                                                                    {!day.isWeekend && !day.holiday && (
                                                                        <div className="w-1.5 h-1.5 bg-blue-200 rounded-full"></div>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Cell Menu Modal */}
                    {activeCell && (
                        <div 
                            className="fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-50 flex items-center justify-center p-4"
                            onClick={() => setActiveCell(null)}
                        >
                            <div 
                                className="bg-white rounded-xl shadow-xl p-4 w-full max-w-sm border-2 border-slate-800 animate-in zoom-in-95 duration-200"
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div className="flex justify-between items-center mb-4 pb-2 border-b border-slate-200">
                                    <div className="flex flex-col">
                                        <span className="text-xs font-bold text-slate-400">ç•¶æ—¥æ’ç­è¨­å®š</span>
                                        <span className="text-xl font-black text-slate-800">
                                            {activeCell.user} <span className="text-slate-400 mx-1">/</span> {activeCell.dateStr}
                                        </span>
                                    </div>
                                    <button onClick={() => setActiveCell(null)} className="p-1 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100">
                                        <XIcon size={24} />
                                    </button>
                                </div>
                                <div className="grid grid-cols-3 gap-3 mb-4">
                                    {Object.values(SHIFT_TYPES).filter(t => t.id !== 'REST' && t.id !== 'NORMAL').map(type => (
                                        <button
                                            key={type.id}
                                            onClick={() => applyShiftFromModal(type.id)}
                                            className={`
                                                flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all btn-press
                                                ${activeCell.currentShift === type.id 
                                                ? 'border-slate-800 bg-slate-50 ring-2 ring-slate-800 ring-offset-1' 
                                                : 'border-slate-200 bg-white hover:border-slate-400'}
                                            `}
                                        >
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl mb-1 ${type.color.split(' ')[0]} text-white`}>
                                                {type.icon}
                                            </div>
                                            <span className="text-sm font-bold text-slate-700">{type.name}</span>
                                        </button>
                                    ))}
                                </div>
                                <div className="flex gap-3 pt-2 border-t border-slate-200">
                                    <button
                                        onClick={() => applyShiftFromModal('ERASER')}
                                        className="flex-1 flex items-center justify-center gap-2 p-3 rounded-xl border-2 border-slate-300 text-slate-600 font-bold hover:bg-slate-50 btn-press"
                                    >
                                        <Trash2 size={18} />
                                        æ¸…é™¤ç•¶æ—¥
                                    </button>
                                    <button
                                        onClick={openAutoFillFromCell}
                                        className="flex-1 flex items-center justify-center gap-2 p-3 rounded-xl border-2 border-slate-800 bg-yellow-100 text-slate-900 font-bold hover:bg-yellow-200 btn-press"
                                    >
                                        <Zap size={18} fill="currentColor" className="text-yellow-600" />
                                        å¾æ­¤æ’ç­
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Auto Fill Modal */}
                    {showAutoFill && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-yellow-100 rounded-lg shadow-lg max-w-sm w-full p-6 border-2 border-slate-900 relative rotate-1">
                                <button onClick={() => setShowAutoFill(false)} className="absolute -top-3 -right-3 bg-white border-2 border-slate-900 rounded-full p-1 hover:rotate-90 transition text-slate-900 shadow-sm">
                                    <XIcon size={20} />
                                </button>
                                <h3 className="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2 border-b-2 border-slate-900 border-dashed pb-2">
                                    <Zap className="text-orange-500 fill-current" />
                                    è‡ªå‹•æ’ç­é­”æ³•
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-lg font-bold text-slate-700">å°è±¡èˆ‡é–‹å§‹æ—¥</label>
                                        <div className="p-3 bg-white border-2 border-slate-400 rounded-lg flex justify-between items-center">
                                            <span className="font-bold text-xl text-slate-800">{targetUser}</span>
                                            <span className="text-sm font-bold text-slate-500">{autoStartDate} èµ·</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-lg font-bold text-slate-700">è¦å‰‡æ˜¯ï¼Ÿ</label>
                                        <div className="mt-1 grid grid-cols-1 gap-2">
                                            <button
                                                onClick={() => { setAutoRule('4-2'); setAutoShiftType('ROTATION_A'); }}
                                                className={`p-3 rounded-lg border-2 text-left transition-all flex items-center gap-3 btn-press
                                                    ${autoRule === '4-2' ? 'border-orange-600 bg-orange-100 text-slate-900' : 'border-slate-300 bg-white text-slate-500'}
                                                `}
                                            >
                                                <div className="font-bold text-lg">å››ç­äºŒè¼ª</div>
                                                <div className="text-sm font-bold bg-white px-2 rounded border border-slate-300">åš2ä¼‘2</div>
                                            </button>
                                            <button
                                                onClick={() => { setAutoRule('week-night'); setAutoShiftType('EVE_WEEKDAY'); }}
                                                className={`p-3 rounded-lg border-2 text-left transition-all flex items-center gap-3 btn-press
                                                    ${autoRule === 'week-night' ? 'border-violet-600 bg-violet-100 text-slate-900' : 'border-slate-300 bg-white text-slate-500'}
                                                `}
                                            >
                                                <div className="font-bold text-lg">å¹³æ—¥å°å¤œ</div>
                                                <div className="text-sm font-bold bg-white px-2 rounded border border-slate-300">é€±å…­ä¼‘</div>
                                            </button>
                                        </div>
                                    </div>
                                    <div className="mt-4 p-4 bg-white/50 rounded-lg border-2 border-slate-300 border-dashed">
                                        {autoRule === '4-2' && (
                                            <div className="animate-in fade-in slide-in-from-top-2 space-y-3">
                                                <div>
                                                    <label className="text-lg font-bold text-slate-700 block mb-1">å¹¾å€‹å›åˆï¼Ÿ</label>
                                                    <div className="flex items-center gap-2">
                                                        <input 
                                                            type="number" min="1" max="50" 
                                                            value={autoRounds} 
                                                            onChange={e => setAutoRounds(Number(e.target.value))}
                                                            className="w-20 bg-white border-2 border-slate-400 rounded p-1 text-center font-bold text-2xl text-slate-800 outline-none focus:border-slate-900"
                                                        />
                                                        <span className="text-lg font-bold text-slate-500">= <span className="text-slate-800">{autoRounds * 4}</span> å¤©</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-lg font-bold text-slate-700 block mb-1">ç­åˆ¥</label>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => setAutoShiftType('ROTATION_A')} className={`flex-1 py-2 rounded-lg text-lg font-bold border-2 btn-press ${autoShiftType === 'ROTATION_A' ? 'bg-orange-500 text-white border-orange-700' : 'bg-white text-slate-500 border-slate-300'}`}>Aç­</button>
                                                        <button onClick={() => setAutoShiftType('ROTATION_B')} className={`flex-1 py-2 rounded-lg text-lg font-bold border-2 btn-press ${autoShiftType === 'ROTATION_B' ? 'bg-teal-500 text-white border-teal-700' : 'bg-white text-slate-500 border-slate-300'}`}>Bç­</button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        {autoRule === 'week-night' && (
                                            <div className="animate-in fade-in slide-in-from-top-2">
                                                <label className="text-lg font-bold text-slate-700 block mb-1">æŒçºŒå¹¾é€±ï¼Ÿ</label>
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="number" min="1" max="52" 
                                                        value={autoWeeksDuration} 
                                                        onChange={e => setAutoWeeksDuration(Number(e.target.value))}
                                                        className="w-20 bg-white border-2 border-slate-400 rounded p-1 text-center font-bold text-2xl text-slate-800"
                                                    />
                                                    <span className="text-lg font-bold text-slate-500">é€±</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="mt-6 flex gap-3">
                                    <button onClick={() => setShowAutoFill(false)} className="flex-1 py-3 rounded-lg font-bold border-2 border-slate-400 text-slate-500 hover:bg-slate-100 transition btn-press">ç®—äº†å§</button>
                                    <button onClick={runAutoFill} className="flex-1 py-3 rounded-lg font-bold border-2 border-slate-800 bg-slate-800 text-white hover:bg-slate-700 btn-press transition">å¯«å…¥ï¼</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Info Modal (è¦å‰‡å‚™å¿˜éŒ„) */}
                    {showInfoModal && (
                        <div 
                            className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[70] flex items-center justify-center p-4"
                            onClick={() => setShowInfoModal(false)}
                        >
                            <div 
                                className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 border-2 border-slate-800 relative"
                                onClick={e => e.stopPropagation()}
                            >
                                <button onClick={() => setShowInfoModal(false)} className="absolute top-3 right-3 text-slate-400 hover:text-slate-600 rounded-full p-1 hover:bg-slate-100">
                                    <XIcon size={24} />
                                </button>
                                <h3 className="text-xl font-black text-slate-800 mb-6 flex items-center gap-2 border-b-2 border-blue-100 pb-3">
                                    <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                        <IconBase size={20}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></IconBase>
                                    </div>
                                    æ’ç­è¦å‰‡å‚™å¿˜
                                </h3>
                                <div className="space-y-6 text-slate-600">
                                    <div className="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                        <h4 className="font-bold text-orange-800 mb-3 flex items-center gap-2 text-sm uppercase tracking-wide">
                                            <span className="w-2 h-2 rounded-full bg-orange-400"></span>
                                            å››äºŒè¼ªæ’ç­é †åº
                                        </h4>
                                        <ul className="space-y-2 text-sm font-medium pl-2">
                                            <li className="flex items-center gap-2 text-slate-700">
                                                <span className="text-orange-300 font-bold">1.</span> ç‹æ³“å‡± + é™³å˜‰è»’
                                            </li>
                                            <li className="flex items-center gap-2 text-slate-700">
                                                <span className="text-orange-300 font-bold">2.</span> å¼µçš“ç¿” + é™³æµ©éœ–
                                            </li>
                                            <li className="flex items-center gap-2 text-slate-700">
                                                <span className="text-orange-300 font-bold">3.</span> ç¿å­æ¶µ + è¶™å©‰å‰
                                            </li>
                                            <li className="flex items-center gap-2 text-slate-700">
                                                <span className="text-orange-300 font-bold">4.</span> æ¸¸ä½³æ†² + æ—æ˜å„’
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <div className="bg-violet-50 p-4 rounded-lg border border-violet-100">
                                        <h4 className="font-bold text-violet-800 mb-3 flex items-center gap-2 text-sm uppercase tracking-wide">
                                            <span className="w-2 h-2 rounded-full bg-violet-400"></span>
                                            å¹³æ—¥ç­å°å¤œé †åº
                                        </h4>
                                        <div className="text-sm text-slate-700 leading-relaxed font-medium">
                                            ç‹æ³“å‡± <span className="text-violet-300 px-1">â†’</span> é™³å˜‰è»’ <span className="text-violet-300 px-1">â†’</span> é™³æµ©éœ– <span className="text-violet-300 px-1">â†’</span> è¶™å©‰å‰ <span className="text-violet-300 px-1">â†’</span> å¼µçš“ç¿” <span className="text-violet-300 px-1">â†’</span> æ—æ˜å„’ <span className="text-violet-300 px-1">â†’</span> ç¿å­æ¶µ <span className="text-violet-300 px-1">â†’</span> æ¸¸ä½³æ†²
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-6 pt-4 border-t border-slate-100 text-center">
                                    <button 
                                        onClick={() => setShowInfoModal(false)}
                                        className="text-sm text-slate-400 hover:text-slate-600 font-bold"
                                    >
                                        é—œé–‰è¦–çª—
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Logout Modal */}
                    {logoutModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-lg max-w-sm w-full p-6 border-2 border-slate-800 animate-in zoom-in-95 duration-200">
                                <div className="w-14 h-14 bg-yellow-200 rounded-full flex items-center justify-center mb-4 border-2 border-slate-800 mx-auto">
                                    <LogOutIcon size={30} className="text-slate-800" />
                                </div>
                                <h3 className="text-2xl font-bold text-slate-800 mb-2 text-center">æº–å‚™ç™»å‡º</h3>
                                <p className="text-lg text-slate-600 mb-8 text-center">æ‚¨å¸Œæœ›åœ¨ç™»å‡ºå‰å…ˆå„²å­˜ç›®å‰çš„è®Šæ›´å—ï¼Ÿ</p>
                                <div className="flex flex-col gap-3">
                                    <button 
                                        onClick={confirmLogoutAndSave} 
                                        disabled={isSaving}
                                        className={`w-full py-3 bg-green-500 text-white rounded-xl font-bold text-lg border-2 border-green-700 shadow-[3px_3px_0px_rgba(21,128,61,1)] btn-press transition flex items-center justify-center gap-2
                                            ${isSaving ? 'opacity-70 cursor-wait' : ''}
                                        `}
                                    >
                                        <SaveIcon size={20} /> 
                                        {isSaving ? 'æ­£åœ¨å­˜æª”ä¸¦ç™»å‡º...' : 'å­˜æª”ä¸¦ç™»å‡º'}
                                    </button>
                                    <button 
                                        onClick={() => setLogoutModal(false)} 
                                        className="w-full py-3 bg-white text-slate-600 rounded-xl font-bold text-lg border-2 border-slate-300 hover:bg-slate-50 btn-press transition"
                                    >
                                        ç¹¼çºŒç·¨è¼¯
                                    </button>
                                    <button 
                                        onClick={confirmLogoutOnly} 
                                        className="mt-2 text-sm text-red-400 hover:text-red-600 font-bold underline decoration-2 underline-offset-4"
                                    >
                                        ç›´æ¥ç™»å‡º (ä¸å­˜æª”)
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Confirm Modal (for both Clear and Clear User) */}
                    {confirmModal.show && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-lg max-w-sm w-full p-6 border-2 border-slate-800 animate-in zoom-in-95 duration-200 -rotate-1">
                                <div className={`w-14 h-14 rounded-full flex items-center justify-center mb-4 border-2 border-slate-800 ${confirmModal.isDangerous ? 'bg-red-100 text-red-500' : 'bg-blue-100 text-blue-500'}`}>
                                    <AlertTriangle size={30} />
                                </div>
                                <h3 className="text-2xl font-bold text-slate-800 mb-2">{confirmModal.title}</h3>
                                <p className="text-lg text-slate-600 mb-8 leading-relaxed">{confirmModal.msg}</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setConfirmModal({ show: false })} className="flex-1 py-3 rounded-lg border-2 border-slate-300 text-slate-600 font-bold hover:bg-slate-50 transition btn-press">å–æ¶ˆ</button>
                                    <button onClick={confirmModal.action} className={`flex-1 py-3 rounded-lg text-white font-bold border-2 border-slate-800 btn-press transition ${confirmModal.isDangerous ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}`}>ç¢ºå®š</button>
                                </div>
                            </div>
                        </div>
                    )}
                </React.Fragment>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ShiftScheduleMatrix />);
    </script>
</body>
</html>
